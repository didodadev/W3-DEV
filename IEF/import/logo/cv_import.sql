/*
Bordro Databaselerinden bilgi alır
Cv Aktarım
ehesap.cv_import
*/
DECLARE @SQLString NVARCHAR(max)

SET @SQLString = N'SELECT 
	ADI as Ad,
	SOYADI as Soyad,
	MERNISNO as TCKimlikNo,
	CASE WHEN CV.MEDENIHAL=''E'' THEN 1  ELSE 0 END as MedeniDurum,
	CASE WHEN CV.CINSIYET=''E'' THEN 1  ELSE 0 END as Cinsiyet,
	CONVERT(VARCHAR, DOG_TARIH , 104)  DogumTarihi, 
	DOG_IL as DogumYeri,
	EMAIL as Eposta,
	ILETISIM.EVADRESI as EvAdresi,
	ILETISIM.EVILCE as Ilçe,
	ILETISIM.EVIL as Sehir,
	'''' as EvTelefonuAlanKodu,
	ILETISIM.EVTEL as EvTelefonu,
	'''' as CepTelAlanKodu,
	ILETISIM.CEPTEL as CepTel, 

	 case when CV.BITIRDIGITAHSILI =''L'' then 1 when CV.BITIRDIGITAHSILI =''Y'' then 2 
		  when CV.BITIRDIGITAHSILI =''S'' then 3 when CV.BITIRDIGITAHSILI =''U'' then 4 
		  when CV.BITIRDIGITAHSILI =''D'' then 5 when CV.BITIRDIGITAHSILI in (''I'',''K'',''O'') then 6 end  
	as  EgitimSeviyesi, 

	 case when CV.BITIRDIGITAHSILI =''L'' then 1 when CV.BITIRDIGITAHSILI =''Y'' then 2 
		  when CV.BITIRDIGITAHSILI =''S'' then 3 when CV.BITIRDIGITAHSILI =''U'' then 4 
		  when CV.BITIRDIGITAHSILI =''D'' then 5 when CV.BITIRDIGITAHSILI in (''I'',''K'',''O'') then 6 end  
	as EgitimSeviyesiID,

	TAHSIL.ILKOKULISMI as OkulAdi,
	'''' as GirisYili,
	TAHSIL.ILKBITISYILI as MezuniyetYili,
	TAHSIL.ILKDERECE as NotOrt,
	'''' as Bolum,
	1  as ID,
	TAHSIL.LISEOKULISMI as OkulAdi,
	'''' as GirisYili,
	TAHSIL.LISEBITISYILI as MezuniyetYili,
	TAHSIL.LISEDERECE as NotOrt,
	TAHSIL.LISEBOLUMU as Bolum,
	'''' as EgitimSeviyesiID,
	'''' as OkulAdi,
	'''' as GirisYili,
	'''' as MezuniyetYili,
	'''' as NotOrt,
	'''' as Bolum,
	'''' as EgitimSeviyesiID,
	'''' as OkulAdi,
	'''' as GirisYili,
	'''' as MezuniyetYili,
	'''' as NotOrt,
	'''' as Bolum,
	'''' as EgitimSeviyesiID,
	'''' as OkulAdi,
	'''' as GirisYili,
	'''' as MezuniyetYili,
	'''' as NotOrt,
	'''' as Bolum,
	'''' as EgitimSeviyesiID,
	'''' as OkulAdi,
	'''' as GirisYili,
	'''' as MezuniyetYili,
	'''' as NotOrt,
	'''' as Bolum,
	'''' as EgitimSeviyesiID,
	'''' as OkulAdi,
	'''' as GirisYili,
	'''' as MezuniyetYili,
	'''' as NotOrt,
	'''' as Bolum,
	'''' as YabanciDil1Adi,
	'''' as KonusmaSeviyesi,
	'''' as AnlamaSeviyesi,
	'''' as YazmaSeviyesi,
	'''' as ogrenildigiYer,
	'''' as YabanciDil2Adi,
	'''' as KonusmaSeviyesi,
	'''' as AnlamaSeviyesi,
	'''' as YazmaSeviyesi,
	'''' as OgrenildigiYer,
	'''' as YabanciDil3Adi,
	'''' as KonusmaSeviyesi,
	'''' as AnlamaSeviyesi,
	'''' as YazmaSeviyesi,
	'''' as OgrenildigiYer,

	--İŞ TECRÜBELERİ
	(SELECT FIRMAADI from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,FIRMAADI FROM TBLCVISTECRUBE) AS t WHERE sira=1) as IsTecrubesi1sirketAdi,
	(SELECT POZISYONU from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,POZISYONU FROM TBLCVISTECRUBE) AS t WHERE sira=1) as Pozisyon,
	(SELECT BASTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,CONVERT(VARCHAR, BASTAR , 104)  BASTAR  FROM TBLCVISTECRUBE) AS t WHERE sira=1) as BaslangiçTarihi,
	(SELECT BITTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,CONVERT(VARCHAR, BITTAR , 104)  BITTAR   FROM TBLCVISTECRUBE) AS t WHERE sira=1) as BitisTarihi,
	(SELECT UNVAN from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,UNVAN FROM TBLCVISTECRUBE) AS t WHERE sira=1) as GorevVeSorumluluk,
	(SELECT AYRILISACIKLAMA from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,AYRILISACIKLAMA FROM TBLCVISTECRUBE) AS t WHERE sira=1) as AyrilmaNedeni,

	(SELECT FIRMAADI from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,FIRMAADI FROM TBLCVISTECRUBE) AS t WHERE sira=2) as IsTecrubesi1sirketAdi2,
	(SELECT POZISYONU from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,POZISYONU FROM TBLCVISTECRUBE) AS t WHERE sira=2) as Pozisyon2,
	(SELECT BASTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,CONVERT(VARCHAR, BASTAR , 104)  BASTAR FROM TBLCVISTECRUBE) AS t WHERE sira=2) as BaslangiçTarihi2,
	(SELECT BITTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,CONVERT(VARCHAR, BITTAR , 104)  BITTAR   FROM TBLCVISTECRUBE) AS t WHERE sira=2) as BitisTarihi2,
	(SELECT UNVAN from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,UNVAN FROM TBLCVISTECRUBE) AS t WHERE sira=2) as GorevVeSorumluluk2,
	(SELECT AYRILISACIKLAMA from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,AYRILISACIKLAMA FROM TBLCVISTECRUBE) AS t WHERE sira=2) as AyrilmaNedeni2,

	(SELECT FIRMAADI from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,FIRMAADI FROM TBLCVISTECRUBE) AS t WHERE sira=3) as IsTecrubesi1sirketAdi3,
	(SELECT POZISYONU from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,POZISYONU FROM TBLCVISTECRUBE) AS t WHERE sira=3) as Pozisyon3,
	(SELECT BASTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,BASTAR FROM TBLCVISTECRUBE) AS t WHERE sira=3) as BaslangiçTarihi3,
	(SELECT BITTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,BITTAR FROM TBLCVISTECRUBE) AS t WHERE sira=3) as BitisTarihi3,
	(SELECT UNVAN from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,UNVAN FROM TBLCVISTECRUBE) AS t WHERE sira=3) as GorevVeSorumluluk3,
	(SELECT AYRILISACIKLAMA from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,AYRILISACIKLAMA FROM TBLCVISTECRUBE) AS t WHERE sira=3) as AyrilmaNedeni3,

	(SELECT FIRMAADI from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,FIRMAADI FROM TBLCVISTECRUBE) AS t WHERE sira=4) as IsTecrubesi1sirketAdi4,
	(SELECT POZISYONU from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,POZISYONU FROM TBLCVISTECRUBE) AS t WHERE sira=4) as Pozisyon4,
	(SELECT BASTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,BASTAR FROM TBLCVISTECRUBE) AS t WHERE sira=4) as BaslangiçTarihi4,
	(SELECT BITTAR from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,BITTAR FROM TBLCVISTECRUBE) AS t WHERE sira=4) as BitisTarihi4,
	(SELECT UNVAN from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,UNVAN FROM TBLCVISTECRUBE) AS t WHERE sira=4) as GorevVeSorumluluk4,
	(SELECT AYRILISACIKLAMA from
	(SELECT ROW_NUMBER() OVER(ORDER BY ISTECRUBEID) AS sira,AYRILISACIKLAMA FROM TBLCVISTECRUBE) AS t WHERE sira=4) as AyrilmaNedeni4,

	--KURSLAR-SERTİFİKALAR
	(SELECT SERTIFIKA_DIGER from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,SERTIFIKA_DIGER FROM TBLCVSERTIFIKATRA) AS t WHERE sira=1)  as Kurs1Konu,
	(SELECT YEAR(BASTAR) from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  CONVERT(VARCHAR, BASTAR , 104)  BASTAR    FROM TBLCVSERTIFIKATRA) AS t WHERE sira=1) as Kurs1Yil,
	(SELECT KURUM from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  KURUM  FROM TBLCVSERTIFIKATRA) AS t WHERE sira=1) as Kurs1Yer,
	(SELECT KURSGUN from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  DATEDIFF(D,BASTAR,BITTAR) AS KURSGUN  FROM TBLCVSERTIFIKATRA) AS t WHERE sira=1) as Kurs1Gun,

	(SELECT SERTIFIKA_DIGER from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,SERTIFIKA_DIGER FROM TBLCVSERTIFIKATRA) AS t WHERE sira=2)  as Kurs2Konu,
	(SELECT YEAR(BASTAR) from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  CONVERT(VARCHAR, BASTAR , 104)  BASTAR    FROM TBLCVSERTIFIKATRA) AS t WHERE sira=2) as Kurs2Yil,
	(SELECT KURUM from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  KURUM  FROM TBLCVSERTIFIKATRA) AS t WHERE sira=2) as Kurs2Yer,
	(SELECT KURSGUN from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  DATEDIFF(D,BASTAR,BITTAR) AS KURSGUN  FROM TBLCVSERTIFIKATRA) AS t WHERE sira=2) as Kurs2Gun,

	(SELECT SERTIFIKA_DIGER from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,SERTIFIKA_DIGER FROM TBLCVSERTIFIKATRA) AS t WHERE sira=3)  as Kurs3Konu,
	(SELECT YEAR(BASTAR) from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  CONVERT(VARCHAR, BASTAR , 104)  BASTAR    FROM TBLCVSERTIFIKATRA) AS t WHERE sira=3) as Kurs3Yil,
	(SELECT KURUM from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  KURUM  FROM TBLCVSERTIFIKATRA) AS t WHERE sira=3) as Kurs3Yer,
	(SELECT KURSGUN from
	(SELECT ROW_NUMBER() OVER(ORDER BY SERTIFIKATRAID) AS sira,  DATEDIFF(D,BASTAR,BITTAR) AS KURSGUN  FROM TBLCVSERTIFIKATRA) AS t WHERE sira=3) as Kurs3Gun,

	(CASE   WHEN CV.ASKERLIKDURUMU=''Y'' THEN 0 
			WHEN CV.ASKERLIKDURUMU=''M'' THEN 1 
			WHEN CV.ASKERLIKDURUMU=''E'' THEN 2 
			WHEN CV.ASKERLIKDURUMU=''T'' THEN 4 END) as AskerlikDurumu,
	(CASE WHEN CV.ASKERLIKDURUMU=''M'' THEN  CONVERT(VARCHAR,  CV.ASKERLIKDURUMTARIHI , 104) END) as AskerlikTerhisTarihi,

	'''' as Devamedenhastaliksorununuzvarmi,

	(CASE WHEN CV.SIGARA=''E'' THEN 1 ELSE 0 END) as SigaraKullaniyormu,
	CV.ENGELLI  as Ozurlumu,
	CV.ESKIHUKUMLU as HukumGiydimi,
	'''' as Kovusturma,
	'''' as EhliyetVerilisYili,
	'''' as EhliyetTipi,
	CV.SEYAHAT_EDEBILIR as Seyahatedebilirmi,

	--REFERANSLAR
	(SELECT ISIM from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,ISIM FROM TBLCVREFERANS) AS t WHERE sira=1)   as Referans1AdSoyad,
	(SELECT KURUM from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,KURUM FROM TBLCVREFERANS) AS t WHERE sira=1)  as Referans1sirket,
	(SELECT UNVAN from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,UNVAN FROM TBLCVREFERANS) AS t WHERE sira=1) as Referans1Pozisyon,
	'''' as Referans1TelAlanKodu,
	(SELECT TELEFON from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,TELEFON FROM TBLCVREFERANS) AS t WHERE sira=1) as Referans1Telefon,
	(SELECT EMAIL from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,EMAIL FROM TBLCVREFERANS) AS t WHERE sira=1) as Referans1Eposta,

	(SELECT ISIM from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,ISIM FROM TBLCVREFERANS) AS t WHERE sira=2)   as Referans2AdSoyad,
	(SELECT KURUM from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,KURUM FROM TBLCVREFERANS) AS t WHERE sira=2)  as Referans2sirket,
	(SELECT UNVAN from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,UNVAN FROM TBLCVREFERANS) AS t WHERE sira=2) as Referans2Pozisyon,
	'''' as Referans1TelAlanKodu,
	(SELECT TELEFON from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,TELEFON FROM TBLCVREFERANS) AS t WHERE sira=2) as Referans2Telefon,
	(SELECT EMAIL from
	(SELECT ROW_NUMBER() OVER(ORDER BY REFID) AS sira,EMAIL FROM TBLCVREFERANS) AS t WHERE sira=2) as Referans2Eposta,

	CV.UCRETBEKLENTISI as İstenilenNetucret,
	CV.BEKLENENHAKLAR as Eklemekİstedikleriniz
FROM
 TBLCVADAY ADAY INNER JOIN
 TBLCV CV ON ADAY.ADAYID = CVID INNER JOIN
 TBLCVKIMLIK KIMLIK ON CV.CVID = KIMLIK.CVID INNER JOIN
 TBLCVILETISIM ILETISIM ON ILETISIM.CVID=CV.CVID INNER JOIN
 TBLCVTAHSIL TAHSIL ON TAHSIL.CVID=CV.CVID'

 
EXECUTE sp_executesql @SQLString


 