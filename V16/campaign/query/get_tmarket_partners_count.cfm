<cfquery name="GET_TMARKET_PARTNERS" datasource="#dsn3#">
	SELECT 	DISTINCT
			CP.PARTNER_ID
	FROM
			#dsn_alias#.COMPANY_PARTNER CP,
			#dsn_alias#.COMPANY C
			<cfif ListLen(TMARKET.COMP_REL_BRANCH) or ListLen(TMARKET.COMP_REL_COMP)>
			,#dsn_alias#.COMPANY_BRANCH_RELATED AS CBR
			</cfif>
			<cfif ListLen(TMARKET.COMP_AGENT_POS_CODE,',')>
			,#dsn_alias#.WORKGROUP_EMP_PAR WEP	
			</cfif>
		WHERE
			C.COMPANY_ID = CP.COMPANY_ID
			<cfif ListLen(TMARKET.COMP_REL_BRANCH) or ListLen(TMARKET.COMP_REL_COMP)>
				AND C.COMPANY_ID = CBR.COMPANY_ID
				AND CP.COMPANY_ID = CBR.COMPANY_ID
				AND CBR.CONSUMER_ID IS NULL
			</cfif>
			<cfif ListLen(TMARKET.COMP_AGENT_POS_CODE,',')>
				AND C.COMPANY_ID = WEP.COMPANY_ID
				AND WEP.COMPANY_ID IS NOT NULL 
				AND WEP.IS_MASTER = 1 
			</cfif>
	<cfif isdefined('TMARKET.REQ_COMP') and len(TMARKET.REQ_COMP)>
		<cfquery name="GET_REQ_PEOPLE" datasource="#DSN3#">
			SELECT 
				PARTNER_ID,COUNT (PARTNER_ID)
			FROM 
				#dsn_alias#.MEMBER_REQ_TYPE 
			WHERE 
				REQ_ID IN (#TMARKET.REQ_COMP#)  
			GROUP BY 
				PARTNER_ID HAVING COUNT(PARTNER_ID)>=#ListLen(TMARKET.REQ_COMP,',')#
		</cfquery>
		<cfset C_REQ=ValueList(GET_REQ_PEOPLE.PARTNER_ID,',')>
		<cfif listlen(C_REQ)>
		 AND CP.COMPANY_ID IN (#C_REQ#) 
		 </cfif>
	</cfif>
	<cfif listlen(TMARKET.PARTNER_STATUS)>AND C.COMPANY_STATUS IN (#TMARKET.PARTNER_STATUS#) AND CP.COMPANY_PARTNER_STATUS IN (#TMARKET.PARTNER_STATUS#)</cfif>
	<cfif listlen(TMARKET.IS_POTANTIAL)>AND C.ISPOTANTIAL IN (#TMARKET.IS_POTANTIAL#)</cfif>
	<cfif listlen(TMARKET.PARTNER_TMARKET_SEX)>AND CP.SEX IN (#LISTSORT(TMARKET.PARTNER_TMARKET_SEX,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.PARTNER_MISSION)>AND CP.MISSION IN (#LISTSORT(TMARKET.PARTNER_MISSION,"NUMERIC")#)</cfif>
	<cfif TMARKET.IS_BUYER eq 1>AND C.IS_BUYER = 1</cfif>
	<cfif TMARKET.IS_SELLER eq 1>AND C.IS_SELLER = 1</cfif>
	<cfif listlen(TMARKET.SECTOR_CATS)>AND C.SECTOR_CAT_ID IN (#LISTSORT(TMARKET.SECTOR_CATS,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.COMPANY_SIZE_CATS)>AND C.COMPANY_SIZE_CAT_ID IN (#LISTSORT(TMARKET.COMPANY_SIZE_CATS,"NUMERIC")#)</cfif>
	<cfif len(TMARKET.PARTNER_STATUS)>AND CP.COMPANY_PARTNER_STATUS	IN(#TMARKET.PARTNER_STATUS#)</cfif>
	<cfif listlen(TMARKET.COMPANYCATS)>AND C.COMPANYCAT_ID IN (#LISTSORT(TMARKET.COMPANYCATS,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.PARTNER_DEPARTMENT)>AND CP.DEPARTMENT IN (#LISTSORT(TMARKET.PARTNER_DEPARTMENT,"NUMERIC")#)</cfif>
    <cfif listlen(TMARKET.COMPANY_COUNTRY_ID)>AND C.COUNTRY IN (#LISTSORT(TMARKET.COMPANY_COUNTRY_ID,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.COMPANY_CITY_ID)>AND C.CITY IN (#LISTSORT(TMARKET.COMPANY_CITY_ID,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.COMPANY_COUNTY_ID)>AND C.COUNTY IN (#LISTSORT(TMARKET.COMPANY_COUNTY_ID,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.COMPANY_VALUE)>AND C.COMPANY_VALUE_ID IN (#LISTSORT(TMARKET.COMPANY_VALUE,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.COMPANY_IMS_CODE)>AND C.IMS_CODE_ID IN (#LISTSORT(TMARKET.COMPANY_IMS_CODE,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.COMPANY_RESOURCE)>AND C.RESOURCE_ID IN (#LISTSORT(TMARKET.COMPANY_RESOURCE,"NUMERIC")#)</cfif>
	<cfif listlen(TMARKET.COMPANY_OZEL_KOD1)>AND C.OZEL_KOD  = '#TMARKET.COMPANY_OZEL_KOD1#'</cfif>
	<cfif listlen(TMARKET.COMPANY_OZEL_KOD2)>AND C.OZEL_KOD_1 = '#TMARKET.COMPANY_OZEL_KOD2#'</cfif>
	<cfif listlen(TMARKET.COMPANY_OZEL_KOD3)>AND C.OZEL_KOD_2 = '#TMARKET.COMPANY_OZEL_KOD3#'</cfif>
	<cfif listlen(TMARKET.COMPANY_SALES_ZONE)>AND C.SALES_COUNTY IN (#LISTSORT(TMARKET.COMPANY_SALES_ZONE,"NUMERIC")#)</cfif>
	<cfif isDefined("attributes.keyword") and len(attributes.keyword)>
		AND (CP.COMPANY_PARTNER_NAME LIKE '%#attributes.keyword#%' OR CP.COMPANY_PARTNER_SURNAME LIKE '%#attributes.keyword#%')
	</cfif>	
	<cfif ListLen(TMARKET.COMP_REL_BRANCH)>
		AND CBR.BRANCH_ID IN (
							<cfloop from="1" to="#ListLen(TMARKET.COMP_REL_BRANCH)#" index="sayac">
							#ListGetAt(TMARKET.COMP_REL_BRANCH,sayac,',')#
								<cfif sayac lt ListLen(TMARKET.COMP_REL_BRANCH)>
								,
								</cfif>
							</cfloop>
						  )
	</cfif>
	<cfif ListLen(TMARKET.COMP_REL_COMP)>
		AND CBR.OUR_COMPANY_ID IN (
							<cfloop from="1" to="#ListLen(TMARKET.COMP_REL_COMP)#" index="sayac2">
							#ListGetAt(TMARKET.COMP_REL_COMP,sayac2,',')#
								<cfif sayac2 lt ListLen(TMARKET.COMP_REL_COMP)>
								,
								</cfif>
							</cfloop>
						  )
	</cfif>
	<cfif ListLen(TMARKET.COMP_AGENT_POS_CODE,',')>
		AND WEP.POSITION_CODE IN
								(
							<cfloop from="1" to="#listlen(TMARKET.COMP_AGENT_POS_CODE,',')#" index="sayac3">
							#ListGetAt(TMARKET.COMP_AGENT_POS_CODE,sayac3,',')#
								<cfif sayac3 lt ListLen(TMARKET.COMP_AGENT_POS_CODE)>
								,
								</cfif>
							</cfloop>
		
								)
	</cfif>
</cfquery>
<cfset GET_TMARKET_PARTNERS_COUNT.TOTAL=GET_TMARKET_PARTNERS.RECORDCOUNT> 
