<cfquery name="GET_HR_OFFTIMES" datasource="#DSN#">
	
    SELECT 
		OFFTIME.OFFTIME_ID, 
		OFFTIME.EMPLOYEE_ID, 
		OFFTIME.VALID,
		OFFTIME.STARTDATE,
		OFFTIME.FINISHDATE,
		OFFTIME.VALIDDATE, 
		OFFTIME.OFFTIMECAT_ID,
		SETUP_OFFTIME.OFFTIMECAT_ID,
		SETUP_OFFTIME.OFFTIMECAT,
		CASE 
            WHEN ISNULL(OFFTIME.SUB_OFFTIMECAT_ID,0) <> 0 THEN (SELECT top 1 OFFTIMECAT FROM SETUP_OFFTIME A WHERE A.OFFTIMECAT_ID = OFFTIME.SUB_OFFTIMECAT_ID)
            WHEN ISNULL(OFFTIME.SUB_OFFTIMECAT_ID,0) = 0 THEN (SELECT top 1  OFFTIMECAT FROM OFFTIME B WHERE B.OFFTIMECAT_ID = OFFTIME.OFFTIMECAT_ID)
        END AS NEW_CAT_NAME
	FROM 
		OFFTIME,
		SETUP_OFFTIME
	WHERE
		OFFTIME.OFFTIMECAT_ID = SETUP_OFFTIME.OFFTIMECAT_ID
	<cfif isDefined("attributes.EMPLOYEE_ID")>
		AND EMPLOYEE_ID=#attributes.EMPLOYEE_ID#		
	</cfif>
    <cfif isDefined("attributes.period_year")>
    	AND (DATEPART(yyyy,OFFTIME.STARTDATE) = #session.ep.PERIOD_YEAR# OR DATEPART(yyyy,OFFTIME.FINISHDATE) = #attributes.period_year#)
    </cfif>
	ORDER BY
		OFFTIME.STARTDATE DESC,OFFTIME.FINISHDATE, SETUP_OFFTIME.OFFTIMECAT
</cfquery>

