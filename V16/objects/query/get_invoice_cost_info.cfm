<cfif isdefined('attributes.invoice_id')><cfset url.id=attributes.invoice_id></cfif>
<cfif not isdefined("attributes.is_stock_fis")>
	<cfquery name="GET_INVOICE_INFO" datasource="#DSN2#">
		SELECT
			INVOICE.COMPANY_ID,
			INVOICE.PARTNER_ID,
			INVOICE.CONSUMER_ID,
			INVOICE.INVOICE_CAT,		
			INVOICE.INVOICE_NUMBER,
			INVOICE.INVOICE_DATE,
			INVOICE_ROW.STOCK_ID,
			INVOICE_ROW.PRODUCT_ID,
			INVOICE_ROW.AMOUNT,
			INVOICE_ROW.UNIT,
			INVOICE_ROW.INVOICE_ROW_ID,
			INVOICE_ROW.STOCK_ID,
			INVOICE_ROW.NAME_PRODUCT,
			INVOICE_ROW.GROSSTOTAL,
			INVOICE_ROW.NETTOTAL,
			INVOICE_ROW.TAXTOTAL,
			INVOICE_ROW.OTVTOTAL,
			ISNULL(INVOICE_ROW.BSMV_AMOUNT,0) BSMVTOTAL,
			ISNULL(INVOICE_ROW.OIV_AMOUNT,0) OIVTOTAL,
			ISNULL(INVOICE_ROW.TEVKIFAT_AMOUNT,0) TEVKIFATTOTAL,
			INVOICE_ROW.OTV_ORAN,
			INVOICE_ROW.TAX,
			ISNULL(INVOICE_ROW.BSMV_RATE,0) BSMV_ORAN,
			ISNULL(INVOICE_ROW.OIV_RATE,0) OIV_ORAN,
			ISNULL(INVOICE_ROW.TEVKIFAT_RATE,0) TEVKIFAT_ORAN,
			INVOICE_ROW.OTHER_MONEY,
			INVOICE_ROW.OTHER_MONEY_VALUE,
			INVOICE_ROW.OTHER_MONEY_GROSS_TOTAL,
			INVOICE_ROW.NAME_PRODUCT,	
			PRODUCT.PRODUCT_NAME,
			PRODUCT.PRODUCT_CATID,
			ISNULL(INVOICE.PROCESS_DATE,INVOICE.INVOICE_DATE) AS PROCESS_DATE	
		FROM
			INVOICE,
			INVOICE_ROW,
			#dsn3_alias#.PRODUCT AS PRODUCT
		WHERE
			INVOICE.INVOICE_ID = #URL.ID# AND
			INVOICE_ROW.INVOICE_ID = INVOICE.INVOICE_ID AND
			PRODUCT.PRODUCT_ID = INVOICE_ROW.PRODUCT_ID AND
			INVOICE_ROW.GROSSTOTAL>0
	</cfquery>
<cfelse>
<!---TolgaS sql 2000 de hata verdi unıon yerine tekilleştirildi ve query of query ile bağlandı araştırmak gerek neden 2005 ile farkını--->
	<cfquery name="GET_INVOICE_INFO_1" datasource="#DSN2#">
		SELECT
			STOCK_FIS.FIS_ID INVOICE_ID,
			NULL COMPANY_ID,
			NULL PARTNER_ID,
			NULL CONSUMER_ID,
			STOCK_FIS.FIS_TYPE INVOICE_CAT,
			STOCK_FIS.FIS_NUMBER INVOICE_NUMBER,
			STOCK_FIS.FIS_DATE INVOICE_DATE,
			STOCK_FIS.IS_COST,
			STOCKS.PRODUCT_ID,
			STOCK_FIS_ROW.AMOUNT,
			STOCK_FIS_ROW.UNIT,
			STOCK_FIS_ROW.STOCK_FIS_ROW_ID INVOICE_ROW_ID,
			STOCK_FIS_ROW.STOCK_ID,
			STOCKS.PRODUCT_NAME NAME_PRODUCT,
			ISNULL(((COST_PRICE+EXTRA_COST)*STOCK_FIS_ROW.AMOUNT),(SELECT TOP 1 (PURCHASE_NET_SYSTEM+PURCHASE_EXTRA_COST_SYSTEM)*STOCK_FIS_ROW.AMOUNT FROM #DSN3_ALIAS#.PRODUCT_COST PC WHERE PC.PRODUCT_ID=STOCKS.PRODUCT_ID AND START_DATE <= STOCK_FIS.FIS_DATE AND SPECT_MAIN_ID IS NULL ORDER BY START_DATE DESC,RECORD_DATE DESC,PRODUCT_COST_ID DESC)) GROSSTOTAL,
			STOCKS.PRODUCT_NAME,
			STOCKS.PRODUCT_CATID,
			0 TAXTOTAL,
			0 OTVTOTAL,
			0 BSMVTOTAL,
			0 OIVTOTAL,
			0 TEVKIFATTOTAL,
			0 TAX,
			0 OTV_ORAN,
			0 BSMV_ORAN,
			0 OIV_ORAN,
			0 TEVKIFAT_ORAN,
			STOCK_FIS.FIS_DATE PROCESS_DATE		
		FROM
			STOCK_FIS,
			STOCK_FIS_ROW,
			#DSN3_ALIAS#.STOCKS AS STOCKS
		WHERE
			STOCK_FIS.FIS_ID = #URL.ID# AND
			STOCK_FIS_ROW.FIS_ID = STOCK_FIS.FIS_ID AND
			STOCKS.STOCK_ID = STOCK_FIS_ROW.STOCK_ID AND
			STOCK_FIS_ROW.SPECT_VAR_ID IS NULL
	</cfquery>
	
	<cfquery name="GET_INVOICE_INFO_2" datasource="#DSN2#">
		SELECT
			STOCK_FIS.FIS_ID INVOICE_ID,
			NULL COMPANY_ID,
			NULL PARTNER_ID,
			NULL CONSUMER_ID,
			STOCK_FIS.FIS_TYPE INVOICE_CAT,
			STOCK_FIS.FIS_NUMBER INVOICE_NUMBER,
			STOCK_FIS.FIS_DATE INVOICE_DATE,
			STOCK_FIS.IS_COST,
			STOCKS.PRODUCT_ID,
			STOCK_FIS_ROW.AMOUNT,
			STOCK_FIS_ROW.UNIT,
			STOCK_FIS_ROW.STOCK_FIS_ROW_ID INVOICE_ROW_ID,
			STOCK_FIS_ROW.STOCK_ID,
			STOCKS.PRODUCT_NAME NAME_PRODUCT,
			ISNULL(((COST_PRICE+EXTRA_COST)*STOCK_FIS_ROW.AMOUNT),(SELECT TOP 1 (PURCHASE_NET_SYSTEM+PURCHASE_EXTRA_COST_SYSTEM)*STOCK_FIS_ROW.AMOUNT FROM #DSN3_ALIAS#.PRODUCT_COST PC WHERE PC.PRODUCT_ID=STOCKS.PRODUCT_ID AND START_DATE <= STOCK_FIS.FIS_DATE AND SPECT_MAIN_ID=SPECTS.SPECT_MAIN_ID ORDER BY START_DATE DESC,RECORD_DATE DESC,PRODUCT_COST_ID DESC)) GROSSTOTAL,
			STOCKS.PRODUCT_NAME,
			STOCKS.PRODUCT_CATID,
			0 TAXTOTAL,
			0 OTVTOTAL,
			0 BSMVTOTAL,
			0 OIVTOTAL,
			0 TEVKIFATTOTAL,
			0 TAX,
			0 OTV_ORAN,
			0 BSMV_ORAN,
			0 OIV_ORAN,
			0 TEVKIFAT_ORAN,
			STOCK_FIS.FIS_DATE PROCESS_DATE	
		FROM
			STOCK_FIS,
			STOCK_FIS_ROW,
			#DSN3_ALIAS#.STOCKS AS STOCKS,
			#DSN3_ALIAS#.SPECTS SPECTS
		WHERE
			STOCK_FIS.FIS_ID = #URL.ID# AND
			STOCK_FIS_ROW.FIS_ID = STOCK_FIS.FIS_ID AND
			STOCKS.STOCK_ID = STOCK_FIS_ROW.STOCK_ID AND
			STOCK_FIS_ROW.SPECT_VAR_ID=SPECTS.SPECT_VAR_ID
	</cfquery>
	<cfquery name="GET_INVOICE_INFO" dbtype="query">
		SELECT 
			* 
		FROM
			GET_INVOICE_INFO_1
	UNION ALL
		SELECT 
			* 
		FROM
			GET_INVOICE_INFO_2
	</cfquery>
</cfif>
