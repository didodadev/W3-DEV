<cf_xml_page_edit fuseact="report.report_ba_bs_print">
<cfsetting showdebugoutput="no">
<cfset Limit_ = 5000>
<cfparam name="attributes.process_type_ba" default="">
<cfparam name="attributes.process_type_bs" default="">
<cfset bs_process_types = "6,48,50,52,53,56,57,58,62,66,531,532,561,121,5311">
<cfset ba_process_types = "12,49,51,54,55,59,60,61,63,64,65,68,591,592,601,690,691">
<cfif len(attributes.process_type_ba) and len(attributes.process_type_bs)>
	<cfset attributes.process_type = attributes.process_type_ba&','&attributes.process_type_bs>
<cfelseif len(attributes.process_type_ba)>
	<cfset attributes.process_type=attributes.process_type_ba>
<cfelseif len(attributes.process_type_bs)>
	<cfset attributes.process_type=attributes.process_type_bs>
</cfif>
<cfif isdate(attributes.startdate)><cf_date tarih = "attributes.startdate"></cfif>
<cfif isdate(attributes.finishdate)><cf_date tarih = "attributes.finishdate"></cfif>
<cfset kurumsal = ''>
<cfset bireysel = ''>
<cfif isdefined("attributes.relation_type") and len(attributes.relation_type)>
	<cfif len(attributes.relation_type) and listfirst(attributes.relation_type,'-') eq 1>
		<cfset kurumsal = listappend(kurumsal,listlast(attributes.relation_type,'-'))>
	<cfelseif len(attributes.relation_type) and listfirst(attributes.relation_type,'-') eq 2>
		<cfset bireysel = listappend(bireysel,listlast(attributes.relation_type,'-'))>
	</cfif>
</cfif>
<cfquery name="GET_BA_BS" datasource="#DSN2#">
SELECT
	SUM(BA_PAPER_COUNT) BA_PAPER_COUNT,
	SUM(BS_PAPER_COUNT) BS_PAPER_COUNT,
	SUM(BA_TOTAL) BA_TOTAL,
	SUM(BS_TOTAL) BS_TOTAL,
	SUM(TAX_TOTAL) TAX_TOTAL,
	SUM(OTV_TOTAL) OTV_TOTAL
	<cfif isdefined("attributes.is_notification")>
	,SUM(BA_PAPER_TOTAL) BA_PAPER_TOTAL
	,SUM(BS_PAPER_TOTAL) BS_PAPER_TOTAL
	</cfif>
		FROM 
		(
			SELECT 
				COMPANY_ID,
				CONSUMER_ID,
				FULLNAME,
				MEMBER_CODE,
				TAXOFFICE,
				TAXNO,
				TELCODE,
				TEL,
				FAX,
				EMAIL,
				TC_IDENTY_NO,
				CITY_ID,
				COUNTRY_ID,
				SUM(PAPER_COUNT_BA) BA_PAPER_COUNT,
				SUM(PAPER_COUNT_BS) BS_PAPER_COUNT,
				<cfif isDefined("BA_OTVTOTAL") and len(BA_OTVTOTAL)>
					SUM(BA_TOTAL+BA_OTVTOTAL) BA_TOTAL,
				<cfelse>
					SUM(BA_TOTAL) BA_TOTAL,
				</cfif>
				<cfif attributes.is_knt eq 1>
				SUM(BS_TOTAL+BS_OTVTOTAL) BS_TOTAL,
				<cfelse>
				SUM(BS_TOTAL) BS_TOTAL,
				</cfif>
				SUM(TAX_TOTAL) TAX_TOTAL,
				SUM(OTV_TOTAL) OTV_TOTAL
				<cfif isdefined("attributes.is_notification")>
				,SUM(BA_PAPER_TOTAL) BA_PAPER_TOTAL
				,SUM(BS_PAPER_TOTAL) BS_PAPER_TOTAL
				</cfif>
			FROM
			(
				SELECT
					COMPANY_ID,
					CONSUMER_ID,
					FULLNAME,
					MEMBER_CODE,
					TAXOFFICE,
					TAXNO,
					TELCODE,
					TEL,
					FAX,
					EMAIL,
					TC_IDENTY_NO,
					CITY_ID,
					COUNTRY_ID,
					COUNT(BA_COUNT) PAPER_COUNT_BA,
					COUNT(BS_COUNT) PAPER_COUNT_BS,
					SUM(BA_NETTOTAL-BA_DISCOUNT) BA_TOTAL,
					SUM(BS_NETTOTAL-BS_DISCOUNT) BS_TOTAL,
					SUM(TAX_TOTAL) TAX_TOTAL,
					SUM(BS_OTVTOTAL) BS_OTVTOTAL,
					SUM(BA_OTVTOTAL) BA_OTVTOTAL,
					SUM(BS_OTVTOTAL+BA_OTVTOTAL) OTV_TOTAL
					<cfif isdefined("attributes.is_notification")>
					,SUM(BA_PAPER_TOTAL-BA_PAPER_DISCOUNT) BA_PAPER_TOTAL
					,SUM(BS_PAPER_TOTAL-BS_PAPER_DISCOUNT) BS_PAPER_TOTAL
					</cfif>
				FROM
				(
					SELECT
					<cfif not isdefined("attributes.is_notification")>
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BS_COUNT,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN NULL ELSE I.INVOICE_ID END AS BA_COUNT,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_NETTOTAL,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(IR.NETTOTAL) END AS BA_NETTOTAL,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_DISCOUNT,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE I.SA_DISCOUNT END AS BA_DISCOUNT,
					<cfelse>
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_PAPER_TOTAL,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(IR.NETTOTAL) END AS BA_PAPER_TOTAL,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_PAPER_DISCOUNT,
					CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE I.SA_DISCOUNT END AS BA_PAPER_DISCOUNT,
					CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BA_NETTOTAL,
					CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BA_COUNT,
					CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BA_DISCOUNT,
					CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_NETTOTAL,
					CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BS_COUNT,
					CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_DISCOUNT,
					</cfif>			
						I.COMPANY_ID,
						NULL CONSUMER_ID,
						C.FULLNAME,
						C.MEMBER_CODE,
						C.TAXOFFICE,
						C.TAXNO,
						C.COMPANY_TELCODE TELCODE,
						C.COMPANY_TEL1 TEL,
						C.COMPANY_FAX FAX,
						C.COMPANY_EMAIL EMAIL,
						(SELECT CP.TC_IDENTITY FROM #dsn_alias#.COMPANY_PARTNER CP WHERE CP.PARTNER_ID = C.MANAGER_PARTNER_ID) TC_IDENTY_NO,
						C.CITY CITY_ID,
						C.COUNTRY COUNTRY_ID,
						SUM(I.TAXTOTAL)/COUNT(IR.INVOICE_ID) TAX_TOTAL,
						<!--- SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) OTV_TOTAL --->
						<cfif not isdefined("attributes.is_notification")>
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_OTVTOTAL,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) END AS BA_OTVTOTAL
						<cfelse>
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_PAPER_OTV,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) END AS BA_PAPER_OTV
						,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BA_OTVTOTAL
						,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_OTVTOTAL
						</cfif>
					FROM
						#dsn_alias#.COMPANY C,
						INVOICE_ROW IR,
						INVOICE I
						<cfif session.ep.our_company_info.is_earchive>
							LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = I.INVOICE_ID AND ERA.ACTION_TYPE = 'INVOICE'
							LEFT JOIN EARCHIVE_SENDING_DETAIL ES ON ES.ACTION_ID = I.INVOICE_ID AND ES.ACTION_TYPE = 'INVOICE' AND ES.SENDING_DETAIL_ID = (SELECT MAX(ES2.SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ES2 WHERE ES2.ACTION_ID=I.INVOICE_ID AND ES2.ACTION_TYPE = 'INVOICE')
						</cfif>
						<cfif session.ep.our_company_info.is_efatura>
							LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = I.INVOICE_ID AND ER.ACTION_TYPE = 'INVOICE'
							LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.INVOICE_ID = I.INVOICE_ID
						</cfif>
						
					WHERE
						I.COMPANY_ID = C.COMPANY_ID AND
						IR.INVOICE_ID = I.INVOICE_ID AND
						I.IS_IPTAL = 0
						<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
							AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) >= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.startdate#">
						</cfif>
						<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
							AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) <= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.finishdate#">
						</cfif>
						<cfif isdefined('attributes.company') and len(attributes.company)>
							<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
								AND I.COMPANY_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#attributes.company_id#">
							<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
								AND 1=0
							</cfif>
						</cfif>
						<cfif isDefined("attributes.row_company") and Len(attributes.row_company)>
							AND I.COMPANY_ID IN (#attributes.row_company#)
						<cfelseif isDefined("attributes.row_consumer") and Len(attributes.row_consumer)>
							AND 1=0
						</cfif>
						<cfif not isDefined("attributes.is_earchive")>
							AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
							AND ERA.ACTION_ID IS NULL
							AND I.INVOICE_NUMBER NOT LIKE 'GIB%'
							AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)
						</cfif>
						<cfif not isDefined("attributes.is_efatura")>
							AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
							AND ER.ACTION_ID  IS NULL
							AND ERD.IS_APPROVE IS NULL
						</cfif>
						AND I.PROCESS_CAT IN (#attributes.process_type#)
					GROUP BY
						I.INVOICE_CAT,
						I.INVOICE_ID,
						I.COMPANY_ID,
						C.FULLNAME,
						C.MEMBER_CODE,
						C.TAXOFFICE,
						C.TAXNO,
						C.COMPANY_TELCODE,
						C.COMPANY_TEL1,
						C.COMPANY_FAX,
						C.COMPANY_EMAIL,
						C.MANAGER_PARTNER_ID,
						C.CITY,
						C.COUNTRY,
						I.SA_DISCOUNT
						<cfif isdefined("attributes.is_notification")>
						,ERA.ACTION_ID
						,I.INVOICE_NUMBER
						,I.IS_EARCHIVE
						,ER.ACTION_ID
						,ERD.IS_APPROVE
						</cfif>
				UNION ALL
					SELECT
						<cfif not isdefined("attributes.is_notification")>
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BS_COUNT,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN NULL ELSE I.INVOICE_ID END AS BA_COUNT,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_NETTOTAL,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(IR.NETTOTAL) END AS BA_NETTOTAL,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_DISCOUNT,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE I.SA_DISCOUNT END AS BA_DISCOUNT,
						<cfelse>
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_PAPER_TOTAL,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(IR.NETTOTAL) END AS BA_PAPER_TOTAL,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_PAPER_DISCOUNT,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE I.SA_DISCOUNT END AS BA_PAPER_DISCOUNT,
						CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BA_NETTOTAL,
						CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BA_COUNT,
						CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BA_DISCOUNT,
						CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_NETTOTAL,
						CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BS_COUNT,
						CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_DISCOUNT,
						</cfif>			
						NULL,
						I.CONSUMER_ID,
						C.CONSUMER_NAME+' '+C.CONSUMER_SURNAME AS FULLNAME,
						C.MEMBER_CODE,
						C.TAX_OFFICE TAXOFFICE,
						C.TAX_NO TAXNO,
						C.MOBIL_CODE TELCODE,
						C.MOBILTEL TEL,
						C.CONSUMER_FAX FAX,
						C.IM EMAIL,
						C.TC_IDENTY_NO,
						C.HOME_CITY_ID CITY_ID,
						C.HOME_COUNTRY_ID COUNTRY_ID,
						SUM(I.TAXTOTAL)/COUNT(I.INVOICE_ID) TAX_TOTAL,
						<!--- SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) OTV_TOTAL --->
						<cfif not isdefined("attributes.is_notification")>
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_OTVTOTAL,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) END AS BA_OTVTOTAL
						<cfelse>
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_PAPER_OTV,
						CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) END AS BA_PAPER_OTV
						,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT NOT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BA_OTVTOTAL
						,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 AND ERA.ACTION_ID IS NULL AND I.INVOICE_NUMBER NOT LIKE 'GIB%' AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0  AND ER.ACTION_ID  IS NULL AND ERD.IS_APPROVE IS NULL) AND I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_OTVTOTAL
						</cfif>
					FROM
						#dsn_alias#.CONSUMER C,
						INVOICE_ROW IR,
						INVOICE I
						<cfif session.ep.our_company_info.is_earchive>
							LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = I.INVOICE_ID AND ERA.ACTION_TYPE = 'INVOICE'
							LEFT JOIN EARCHIVE_SENDING_DETAIL ES ON ES.ACTION_ID = I.INVOICE_ID AND ES.ACTION_TYPE = 'INVOICE' AND ES.SENDING_DETAIL_ID = (SELECT MAX(ES2.SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ES2 WHERE ES2.ACTION_ID=I.INVOICE_ID AND ES2.ACTION_TYPE = 'INVOICE')
						</cfif>
						<cfif session.ep.our_company_info.is_efatura>
							LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = I.INVOICE_ID AND ER.ACTION_TYPE = 'INVOICE'
							LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.INVOICE_ID = I.INVOICE_ID
						</cfif>
					WHERE
						I.CONSUMER_ID = C.CONSUMER_ID AND
						IR.INVOICE_ID = I.INVOICE_ID AND
						I.IS_IPTAL = 0
						<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
							AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) >= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.startdate#">
						</cfif>
						<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
							AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) <= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.finishdate#">
						</cfif>
						<cfif isdefined('attributes.company') and len(attributes.company)>
							<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
								AND 1=0
							<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
								AND I.CONSUMER_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#attributes.consumer_id#">
							</cfif>
						</cfif>
						<cfif isDefined("attributes.row_consumer") and Len(attributes.row_consumer)>
							AND I.CONSUMER_ID IN (#attributes.row_consumer#)
						<cfelseif isDefined("attributes.row_company") and Len(attributes.row_company)>
							AND 1=0
						</cfif>
						<cfif not isDefined("attributes.is_earchive")>
							AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
							AND ERA.ACTION_ID IS NULL
							AND I.INVOICE_NUMBER NOT LIKE 'GIB%'
							AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)
						</cfif>
						<cfif not isDefined("attributes.is_efatura")>
							AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
							AND ER.ACTION_ID  IS NULL
							AND ERD.IS_APPROVE IS NULL
						</cfif>
						AND I.PROCESS_CAT IN (#attributes.process_type#)
					GROUP BY
						I.INVOICE_CAT,
						I.INVOICE_ID,
						I.CONSUMER_ID,
						C.CONSUMER_NAME+' '+C.CONSUMER_SURNAME,
						C.MEMBER_CODE,
						C.TAX_OFFICE,
						C.TAX_NO,
						C.MOBIL_CODE,
						C.MOBILTEL,
						C.CONSUMER_FAX,
						C.IM,
						C.TC_IDENTY_NO,
						C.HOME_CITY_ID,
						C.HOME_COUNTRY_ID,
						I.SA_DISCOUNT
						<cfif isdefined("attributes.is_notification")>
						,ERA.ACTION_ID
						,I.INVOICE_NUMBER
						,I.IS_EARCHIVE
						,ER.ACTION_ID
						,ERD.IS_APPROVE
						</cfif>
				) T1
				GROUP BY
					COMPANY_ID,
					CONSUMER_ID,
					FULLNAME,
					MEMBER_CODE,
					TAXOFFICE,
					TAXNO,
					TELCODE,
					TEL,
					FAX,
					EMAIL,
					TC_IDENTY_NO,
					CITY_ID,
					COUNTRY_ID
			UNION ALL
				SELECT
					COMPANY_ID,
					CONSUMER_ID,
					FULLNAME,
					MEMBER_CODE,
					TAXOFFICE,
					TAXNO,
					TELCODE,
					TEL,
					FAX,
					EMAIL,
					TC_IDENTY_NO,
					CITY_ID,
					COUNTRY_ID,
					COUNT(BA_COUNT) PAPER_COUNT_BA,
					COUNT(BS_COUNT) PAPER_COUNT_BS,
					SUM(BA_NETTOTAL) BA_TOTAL,
					SUM(BS_NETTOTAL) BS_TOTAL,
					SUM(TAX_TOTAL) TAX_TOTAL,
					SUM(BS_OTVTOTAL) BS_OTVTOTAL,
					SUM(BA_OTVTOTAL) BA_OTVTOTAL,
					SUM(BS_OTVTOTAL+BA_OTVTOTAL) OTV_TOTAL
					<cfif isdefined("attributes.is_notification")>
					,SUM(BA_PAPER_TOTAL) BA_PAPER_TOTAL
					,SUM(BS_PAPER_TOTAL) BS_PAPER_TOTAL
					</cfif>
				FROM
					(
						SELECT
							<cfif not isdefined("attributes.is_notification")>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BS_COUNT,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN NULL ELSE E.EXPENSE_ID END AS BA_COUNT,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_NETTOTAL,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(TOTAL_AMOUNT) END AS BA_NETTOTAL,
							<cfelse>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_PAPER_TOTAL,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(TOTAL_AMOUNT) END AS BA_PAPER_TOTAL,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL) AND E.ACTION_TYPE NOT IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BA_NETTOTAL,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL) AND E.ACTION_TYPE NOT IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BA_COUNT,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_NETTOTAL,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BS_COUNT,
							</cfif>
							E.CH_COMPANY_ID COMPANY_ID,
							NULL CONSUMER_ID,
							FULLNAME,
							C.MEMBER_CODE,
							C.TAXOFFICE TAXOFFICE,
							C.TAXNO TAXNO,
							C.COMPANY_TELCODE TELCODE,
							C.COMPANY_TEL1 TEL,
							C.COMPANY_FAX FAX,
							C.COMPANY_EMAIL EMAIL,
							(SELECT CP.TC_IDENTITY FROM #dsn_alias#.COMPANY_PARTNER CP WHERE CP.PARTNER_ID = C.MANAGER_PARTNER_ID) TC_IDENTY_NO,
							C.CITY CITY_ID,
							C.COUNTRY COUNTRY_ID,
							SUM(E.KDV_TOTAL) TAX_TOTAL,
							<!--- SUM(OTV_TOTAL) OTV_TOTAL --->
							<cfif not isdefined("attributes.is_notification")>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_OTVTOTAL,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(OTV_TOTAL) END AS BA_OTVTOTAL
							<cfelse>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_PAPER_OTV,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(OTV_TOTAL) END AS BA_PAPER_OTV
							,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE NOT IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BA_OTVTOTAL
							,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_OTVTOTAL
							</cfif>
						FROM
							
							#dsn_alias#.COMPANY C,
							EXPENSE_ITEM_PLANS E
							<cfif session.ep.our_company_info.is_efatura>
								LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = E.EXPENSE_ID AND ER.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
								LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.EXPENSE_ID = E.EXPENSE_ID
							</cfif>
							<cfif session.ep.our_company_info.is_earchive>
								LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = E.EXPENSE_ID AND ERA.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
							</cfif> 
						WHERE
							E.CH_COMPANY_ID = C.COMPANY_ID
							<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
								AND E.EXPENSE_DATE >= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.startdate#">
							</cfif>
							<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
								AND E.EXPENSE_DATE <= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.finishdate#">
							</cfif>	
							<cfif isdefined('attributes.company') and len(attributes.company)>
								<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
									AND E.CH_COMPANY_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#attributes.company_id#">
								<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
									AND 1 = 0
								</cfif>
							</cfif>
							<cfif isDefined("attributes.row_company") and Len(attributes.row_company)>
								AND E.CH_COMPANY_ID IN (#attributes.row_company#)
							<cfelseif isDefined("attributes.row_consumer") and Len(attributes.row_consumer)>
								AND 1=0
							</cfif>
							<cfif not isDefined("attributes.is_earchive")>
								AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 
								AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)
							</cfif>
							<cfif not isDefined("attributes.is_efatura")>
								AND (SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  
								AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0
								AND ERD.IS_APPROVE IS NULL
							</cfif>
							AND E.PROCESS_CAT IN (#attributes.process_type#)
						GROUP BY
							E.ACTION_TYPE,
							E.EXPENSE_ID,
							E.CH_COMPANY_ID,
							CH_CONSUMER_ID,
							FULLNAME,
							C.MEMBER_CODE,
							C.TAXOFFICE,
							C.TAXNO,
							C.COMPANY_TELCODE,
							C.COMPANY_TEL1,
							C.COMPANY_FAX,
							C.COMPANY_EMAIL,
							C.MANAGER_PARTNER_ID,
							C.CITY,
							C.COUNTRY
							<cfif isdefined("attributes.is_notification")>
							,E.IS_EARCHIVE
							,ERD.IS_APPROVE
							</cfif>
					UNION ALL
							SELECT
							<cfif not isdefined("attributes.is_notification")>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BS_COUNT,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN NULL ELSE E.EXPENSE_ID END AS BA_COUNT,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_NETTOTAL,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(TOTAL_AMOUNT) END AS BA_NETTOTAL,
							<cfelse>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_PAPER_TOTAL,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(TOTAL_AMOUNT) END AS BA_PAPER_TOTAL,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL) AND E.ACTION_TYPE NOT IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BA_NETTOTAL,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL) AND E.ACTION_TYPE NOT IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BA_COUNT,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_NETTOTAL,
							CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BS_COUNT,
							</cfif>
							NULL CH_COMPANY_ID,
							E.CH_CONSUMER_ID CONSUMER_ID,
							C.CONSUMER_NAME+' '+C.CONSUMER_SURNAME AS FULLNAME,
							C.MEMBER_CODE,
							C.TAX_OFFICE TAXOFFICE,
							C.TAX_NO TAXNO,
							C.MOBIL_CODE TELCODE,
							C.MOBILTEL TEL,
							C.CONSUMER_FAX FAX,
							C.IM EMAIL,
							C.TC_IDENTY_NO,
							C.HOME_CITY_ID CITY_ID,
							C.HOME_COUNTRY_ID COUNTRY_ID,
							SUM(E.KDV_TOTAL) TAX_TOTAL,
							<!--- SUM(OTV_TOTAL) OTV_TOTAL --->
							<cfif not isdefined("attributes.is_notification")>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_OTVTOTAL,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(OTV_TOTAL) END AS BA_OTVTOTAL
							<cfelse>
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_PAPER_OTV,
							CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(OTV_TOTAL) END AS BA_PAPER_OTV
							,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE NOT IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BA_OTVTOTAL
							,CASE WHEN ((SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)) AND ((SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0 AND ERD.IS_APPROVE IS NULL)  AND E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_OTVTOTAL
							</cfif>
						FROM
							#dsn_alias#.CONSUMER C,
							EXPENSE_ITEM_PLANS E
							<cfif session.ep.our_company_info.is_efatura>
								LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = E.EXPENSE_ID AND ER.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
								LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.EXPENSE_ID = E.EXPENSE_ID
							</cfif>
							<cfif session.ep.our_company_info.is_earchive>
								LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = E.EXPENSE_ID AND ERA.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
							</cfif> 
						WHERE
							E.CH_CONSUMER_ID = C.CONSUMER_ID
							<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
								AND E.EXPENSE_DATE >= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.startdate#">
							</cfif>
							<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
								AND E.EXPENSE_DATE <= <cfqueryparam cfsqltype="cf_sql_timestamp" value="#attributes.finishdate#">
							</cfif>
							<cfif isdefined('attributes.company') and len(attributes.company)>
								<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
									AND 1=0
								<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
									AND E.CH_CONSUMER_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#attributes.consumer_id#">
								</cfif>
							</cfif>
							<cfif isDefined("attributes.row_consumer") and Len(attributes.row_consumer)>
								AND E.CH_CONSUMER_ID IN (#attributes.row_consumer#)
							<cfelseif isDefined("attributes.row_company") and Len(attributes.row_company)>
								AND 1=0
							</cfif>
							<cfif not isDefined("attributes.is_earchive")>
								AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 
								AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)
							</cfif>
							<cfif not isDefined("attributes.is_efatura")>
								AND (SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  
								AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0
								AND ERD.IS_APPROVE IS NULL
							</cfif>
							AND E.PROCESS_CAT IN (#attributes.process_type#)
						GROUP BY
							E.ACTION_TYPE,
							E.EXPENSE_ID,
							E.CH_CONSUMER_ID,
							C.CONSUMER_NAME+' '+C.CONSUMER_SURNAME,
							C.MEMBER_CODE,
							C.TAX_OFFICE,
							C.TAX_NO,
							C.MOBIL_CODE,
							C.MOBILTEL,
							C.CONSUMER_FAX,
							C.IM,
							C.TC_IDENTY_NO,
							C.HOME_CITY_ID,
							C.HOME_COUNTRY_ID
							<cfif isdefined("attributes.is_notification")>
							,E.IS_EARCHIVE
							,ERD.IS_APPROVE
							</cfif>
					)EXP1
				GROUP BY
					COMPANY_ID,
					CONSUMER_ID,
					FULLNAME,
					MEMBER_CODE,
					TAXOFFICE,
					TAXNO,
					TELCODE,
					TEL,
					FAX,
					EMAIL,
					TC_IDENTY_NO,
					CITY_ID,
					COUNTRY_ID
			) BA_BS
			GROUP BY
				COMPANY_ID,
				CONSUMER_ID,
				FULLNAME,
				MEMBER_CODE,
				TAXOFFICE,
				TAXNO,
				TELCODE,
				TEL,
				FAX,
				EMAIL,
				TC_IDENTY_NO,
				CITY_ID,
				COUNTRY_ID
	
		) AS AA
		<cfif isDefined("attributes.total") and len(attributes.total)>
			HAVING
			<cfif not isdefined("attributes.is_notification")>
				SUM(BS_TOTAL) > = #attributes.total# OR SUM(BA_TOTAL) > = #attributes.total#
			<cfelse>
				SUM(BS_PAPER_TOTAL) > = #attributes.total# OR SUM(BA_PAPER_TOTAL) > = #attributes.total#
			</cfif>
		</cfif> 
</cfquery>
	<cfif isdefined("attributes.is_relation") and attributes.is_relation eq 1>
		<cfquery name="get_related_member" datasource="#dsn2#">
		SELECT
			SUM(BA_PAPER_COUNT) BA_PAPER_COUNT,
			SUM(BS_PAPER_COUNT) BS_PAPER_COUNT,
			SUM(BA_TOTAL) BA_TOTAL,
			SUM(BS_TOTAL) BS_TOTAL,
			SUM(TAX_TOTAL) TAX_TOTAL,
			SUM(OTV_TOTAL) OTV_TOTAL
				FROM 
				(
					SELECT
						PARTNER_COMPANY_ID,
						PARTNER_CONSUMER_ID,
						SUM(PAPER_COUNT_BA) BA_PAPER_COUNT,
						SUM(PAPER_COUNT_BS) BS_PAPER_COUNT,
						SUM(BA_TOTAL) BA_TOTAL,
						SUM(BS_TOTAL) BS_TOTAL,
						SUM(TAX_TOTAL) TAX_TOTAL,
						SUM(OTV_TOTAL) OTV_TOTAL
					FROM
					(
						SELECT
							PARTNER_COMPANY_ID,
							PARTNER_CONSUMER_ID,
							COUNT(BA_COUNT) PAPER_COUNT_BA,
							COUNT(BS_COUNT) PAPER_COUNT_BS,
							SUM(BA_NETTOTAL-BA_DISCOUNT) BA_TOTAL,
							SUM(BS_NETTOTAL-BS_DISCOUNT) BS_TOTAL,
							SUM(TAX_TOTAL) TAX_TOTAL,
							SUM(BS_OTVTOTAL) BS_OTVTOTAL,
							SUM(BA_OTVTOTAL) BA_OTVTOTAL,
							SUM(BS_OTVTOTAL+BA_OTVTOTAL) OTV_TOTAL
						FROM
						(
							SELECT
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BS_COUNT,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN NULL ELSE I.INVOICE_ID END AS BA_COUNT,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_NETTOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(IR.NETTOTAL) END AS BA_NETTOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_DISCOUNT,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE I.SA_DISCOUNT END AS BA_DISCOUNT,
								CPR.COMPANY_ID PARTNER_COMPANY_ID,
								'' AS PARTNER_CONSUMER_ID,
								SUM(I.TAXTOTAL)/COUNT(IR.INVOICE_ID) TAX_TOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_OTVTOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) END AS BA_OTVTOTAL
							FROM
								#dsn_alias#.COMPANY C,
								#dsn_alias#.COMPANY_PARTNER_RELATION CPR,
								INVOICE_ROW IR,
								INVOICE I
								<cfif session.ep.our_company_info.is_earchive>
									LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = I.INVOICE_ID AND ERA.ACTION_TYPE = 'INVOICE'
									LEFT JOIN EARCHIVE_SENDING_DETAIL ES ON ES.ACTION_ID = I.INVOICE_ID AND ES.ACTION_TYPE = 'INVOICE' AND ES.SENDING_DETAIL_ID = (SELECT MAX(ES2.SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ES2 WHERE ES2.ACTION_ID=I.INVOICE_ID AND ES2.ACTION_TYPE = 'INVOICE')
								</cfif>
								<cfif session.ep.our_company_info.is_efatura>
									LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = I.INVOICE_ID AND ER.ACTION_TYPE = 'INVOICE'
									LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.INVOICE_ID = I.INVOICE_ID
								</cfif>
							WHERE
								I.COMPANY_ID = CPR.PARTNER_COMPANY_ID AND
								CPR.PARTNER_COMPANY_ID = C.COMPANY_ID AND
								IR.INVOICE_ID = I.INVOICE_ID AND
								I.IS_IPTAL = 0
								<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
									AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) >= #attributes.startdate#
								</cfif>
								<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
									AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) <= #attributes.finishdate#
								</cfif>
								<cfif isdefined('attributes.company') and len(attributes.company)>
									<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
										AND CPR.COMPANY_ID = #attributes.company_id#
									<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
										AND 1=0
									</cfif>
								</cfif>
								<cfif isDefined("attributes.tax_no") and len(attributes.tax_no)>
									AND C.TAXNO = <cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tax_no#">
								</cfif>
								<cfif isdefined("kurumsal") and listlen(kurumsal)>
									AND CPR.PARTNER_RELATION_ID = #kurumsal#
								</cfif>
								<cfif isdefined("bireysel") and listlen(bireysel)>
									AND 1 = 0
								</cfif>
								<cfif isDefined("attributes.tckn") and len(attributes.tckn)>
									AND C.COMPANY_ID IN
									(SELECT CP.COMPANY_ID FROM #dsn_alias#.COMPANY_PARTNER CP WHERE CP.TC_IDENTITY=<cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tckn#">)
								</cfif>
								<cfif not isDefined("attributes.is_earchive")>
									AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
									AND ERA.ACTION_ID IS NULL
									AND I.INVOICE_NUMBER NOT LIKE 'GIB%'
									AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)
								</cfif>
								<cfif not isDefined("attributes.is_efatura")>
									AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
									AND ER.ACTION_ID  IS NULL
									AND ERD.IS_APPROVE IS NULL
								</cfif>
								AND I.PROCESS_CAT IN (#attributes.process_type#)
							GROUP BY
								I.INVOICE_CAT,
								I.INVOICE_ID,
								CPR.COMPANY_ID,
								I.SA_DISCOUNT
						UNION ALL
							SELECT
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.INVOICE_ID ELSE NULL END AS BS_COUNT,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN NULL ELSE I.INVOICE_ID END AS BA_COUNT,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(IR.NETTOTAL) ELSE 0 END AS BS_NETTOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(IR.NETTOTAL) END AS BA_NETTOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN I.SA_DISCOUNT ELSE 0 END AS BS_DISCOUNT,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE I.SA_DISCOUNT END AS BA_DISCOUNT,
								'' PARTNER_COMPANY_ID,
								CTC.CONSUMER_ID AS PARTNER_CONSUMER_ID,
								SUM(I.TAXTOTAL)/COUNT(I.INVOICE_ID) TAX_TOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) ELSE 0 END AS BS_OTVTOTAL,
								CASE WHEN I.INVOICE_CAT IN (#bs_process_types#) THEN 0 ELSE SUM(ISNULL(I.OTV_TOTAL,0))/COUNT(IR.INVOICE_ID) END AS BA_OTVTOTAL
							FROM
								#dsn_alias#.CONSUMER C,
								#dsn_alias#.CONSUMER_TO_CONSUMER CTC,
								INVOICE_ROW IR,
								INVOICE I
								<cfif session.ep.our_company_info.is_earchive>
									LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = I.INVOICE_ID AND ERA.ACTION_TYPE = 'INVOICE'
									LEFT JOIN EARCHIVE_SENDING_DETAIL ES ON ES.ACTION_ID = I.INVOICE_ID AND ES.ACTION_TYPE = 'INVOICE' AND ES.SENDING_DETAIL_ID = (SELECT MAX(ES2.SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ES2 WHERE ES2.ACTION_ID=I.INVOICE_ID AND ES2.ACTION_TYPE = 'INVOICE')
								</cfif>
								<cfif session.ep.our_company_info.is_efatura>
									LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = I.INVOICE_ID AND ER.ACTION_TYPE = 'INVOICE'
									LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.INVOICE_ID = I.INVOICE_ID
								</cfif>
							WHERE
								I.CONSUMER_ID = CTC.CONSUMER2_ID AND
								CTC.CONSUMER2_ID = C.CONSUMER_ID AND
								IR.INVOICE_ID = I.INVOICE_ID AND
								I.IS_IPTAL = 0
								<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
									AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) >= #attributes.startdate#
								</cfif>
								<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
									AND ISNULL(I.REALIZATION_DATE,I.INVOICE_DATE) <= #attributes.finishdate#
								</cfif>
								<cfif isDefined("attributes.tax_no") and len(attributes.tax_no)>
									AND C.TAX_NO = <cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tax_no#">
								</cfif>
								<cfif isDefined("attributes.tckn") and len(attributes.tckn)>
									AND C.TC_IDENTY_NO = <cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tckn#">
								</cfif>
								<cfif isdefined('attributes.company') and len(attributes.company)>
									<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
										AND 1=0
									<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
										AND CTC.CONSUMER2_ID = #attributes.consumer_id#
									</cfif>
								</cfif>
								<cfif isdefined("bireysel") and listlen(bireysel)>
									AND CTC.RELATION_ID = #bireysel#
								</cfif>
								<cfif isdefined("kurumsal") and listlen(kurumsal)>
									AND 1 = 0
								</cfif>
								<cfif not isDefined("attributes.is_earchive")>
									AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
									AND ERA.ACTION_ID IS NULL
									AND I.INVOICE_NUMBER NOT LIKE 'GIB%'
									AND (I.IS_EARCHIVE = 0 OR I.IS_EARCHIVE IS NULL)
								</cfif>
								<cfif not isDefined("attributes.is_efatura")>
									AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = I.INVOICE_ID AND ESD.ACTION_TYPE = 'INVOICE' AND STATUS_CODE = 1) = 0 
									AND ER.ACTION_ID  IS NULL
									AND ERD.IS_APPROVE IS NULL
								</cfif>
								AND I.PROCESS_CAT IN (#attributes.process_type#)
							GROUP BY
								I.INVOICE_CAT,
								I.INVOICE_ID,
								CTC.CONSUMER_ID,
								I.SA_DISCOUNT
						) T1
						GROUP BY
							PARTNER_COMPANY_ID,
							PARTNER_CONSUMER_ID
					UNION ALL
						SELECT
							PARTNER_COMPANY_ID,
							PARTNER_CONSUMER_ID,
							COUNT(BA_COUNT) PAPER_COUNT_BA,
							COUNT(BS_COUNT) PAPER_COUNT_BS,
							SUM(BA_NETTOTAL) BA_TOTAL,
							SUM(BS_NETTOTAL) BS_TOTAL,
							SUM(TAX_TOTAL) TAX_TOTAL,
							SUM(BS_OTVTOTAL) BS_OTVTOTAL,
							SUM(BA_OTVTOTAL) BA_OTVTOTAL,
							SUM(BS_OTVTOTAL+BA_OTVTOTAL) OTV_TOTAL
						FROM
							(
								SELECT
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BS_COUNT,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN NULL ELSE E.EXPENSE_ID END AS BA_COUNT,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_NETTOTAL,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(TOTAL_AMOUNT) END AS BA_NETTOTAL,
									CPR.COMPANY_ID PARTNER_COMPANY_ID,
									'' AS PARTNER_CONSUMER_ID,
									SUM(E.KDV_TOTAL) TAX_TOTAL,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_OTVTOTAL,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(OTV_TOTAL) END AS BA_OTVTOTAL
								FROM
									#dsn_alias#.COMPANY C,
									#dsn_alias#.COMPANY_PARTNER_RELATION CPR,
									EXPENSE_ITEM_PLANS E
									<cfif session.ep.our_company_info.is_efatura>
										LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = E.EXPENSE_ID AND ER.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
										LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.EXPENSE_ID = E.EXPENSE_ID
									</cfif>
									<cfif session.ep.our_company_info.is_earchive>
										LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = E.EXPENSE_ID AND ERA.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
									</cfif> 
								WHERE
									E.CH_COMPANY_ID = CPR.PARTNER_COMPANY_ID AND
									CPR.PARTNER_COMPANY_ID = C.COMPANY_ID
									<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
										AND E.EXPENSE_DATE >= #attributes.startdate#
									</cfif>
									<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
										AND E.EXPENSE_DATE <= #attributes.finishdate#
									</cfif>
									<cfif isdefined('attributes.company') and len(attributes.company)>
										<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
											AND CPR.COMPANY_ID = #attributes.company_id#
										<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
											AND 1 = 0
										</cfif>
									</cfif>
									<cfif isDefined("attributes.tckn") and len(attributes.tckn)>
										AND C.COMPANY_ID IN
										(SELECT CP.COMPANY_ID FROM #dsn_alias#.COMPANY_PARTNER CP WHERE CP.TC_IDENTITY=<cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tckn#">)
									</cfif>
									<cfif isdefined("kurumsal") and listlen(kurumsal)>
										AND CPR.PARTNER_RELATION_ID = #kurumsal#
									</cfif>
									<cfif isdefined("bireysel") and listlen(bireysel)>
										AND 1 = 0
									</cfif>
									<cfif isDefined("attributes.tax_no") and len(attributes.tax_no)>
										AND C.TAXNO = <cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tax_no#">
									</cfif>
									<cfif not isDefined("attributes.is_earchive")>
										AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0 
										AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL)
									</cfif>
									<cfif not isDefined("attributes.is_efatura")>
										AND (SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  
										AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0
										AND ERD.IS_APPROVE IS NULL
									</cfif>
									AND E.PROCESS_CAT IN (#attributes.process_type#)
								GROUP BY
									E.ACTION_TYPE,
									E.EXPENSE_ID,
									CPR.COMPANY_ID
							UNION ALL
								SELECT
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN E.EXPENSE_ID ELSE NULL END AS BS_COUNT,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN NULL ELSE E.EXPENSE_ID END AS BA_COUNT,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(TOTAL_AMOUNT) ELSE 0 END AS BS_NETTOTAL,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(TOTAL_AMOUNT) END AS BA_NETTOTAL,
									'' PARTNER_COMPANY_ID,
									CTC.CONSUMER_ID AS PARTNER_CONSUMER_ID,
									SUM(E.KDV_TOTAL) TAX_TOTAL,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN SUM(OTV_TOTAL) ELSE 0 END AS BS_OTVTOTAL,
									CASE WHEN E.ACTION_TYPE IN (#bs_process_types#) THEN 0 ELSE SUM(OTV_TOTAL) END AS BA_OTVTOTAL
								FROM
									#dsn_alias#.CONSUMER C,
									#dsn_alias#.CONSUMER_TO_CONSUMER CTC,
									EXPENSE_ITEM_PLANS E
									<cfif session.ep.our_company_info.is_efatura>
										LEFT JOIN EINVOICE_RELATION ER ON ER.ACTION_ID = E.EXPENSE_ID AND ER.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
										LEFT JOIN EINVOICE_RECEIVING_DETAIL ERD ON ERD.EXPENSE_ID = E.EXPENSE_ID
									</cfif>
									<cfif session.ep.our_company_info.is_earchive>
										LEFT JOIN EARCHIVE_RELATION ERA ON ERA.ACTION_ID = E.EXPENSE_ID AND ERA.ACTION_TYPE = 'EXPENSE_ITEM_PLANS'
									</cfif> 
								WHERE
									E.CH_CONSUMER_ID = CTC.CONSUMER2_ID AND
									CTC.CONSUMER2_ID = C.CONSUMER_ID
									<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
										AND E.EXPENSE_DATE >= #attributes.startdate#
									</cfif>
									<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
										AND E.EXPENSE_DATE <= #attributes.finishdate#
									</cfif>
									<cfif isdefined('attributes.company') and len(attributes.company)>
										<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
											AND 1=0
										<cfelseif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
											AND CTC.CONSUMER2_ID = #attributes.consumer_id#
										</cfif>
									</cfif>
									<cfif isDefined("attributes.tax_no") and len(attributes.tax_no)>
										AND C.TAX_NO = <cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tax_no#">
									</cfif>
									<cfif isDefined("attributes.tckn")and len(attributes.tckn)>
										AND C.TC_IDENTY_NO = <cfqueryparam cfsqltype="cf_sql_varchar" value="#attributes.tckn#">
									</cfif>
									<cfif isdefined("bireysel") and listlen(bireysel)>
										AND CTC.RELATION_ID = #bireysel#
									</cfif>
									<cfif isdefined("kurumsal") and listlen(kurumsal)>
										AND 1 = 0
									</cfif>
									<cfif not isDefined("attributes.is_earchive")>
										AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EARCHIVE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE = 1) = 0
										AND (E.IS_EARCHIVE = 0 OR E.IS_EARCHIVE IS NULL) 
									</cfif>
									<cfif not isDefined("attributes.is_efatura")>
										AND (SELECT COUNT(RECEIVING_DETAIL_ID) FROM EINVOICE_RECEIVING_DETAIL ESD1 WHERE ESD1.EXPENSE_ID = E.EXPENSE_ID ) = 0  
										AND (SELECT COUNT(SENDING_DETAIL_ID) FROM EINVOICE_SENDING_DETAIL ESD WHERE ESD.ACTION_ID = E.EXPENSE_ID AND ESD.ACTION_TYPE = 'EXPENSE_ITEM_PLANS' AND STATUS_CODE=1) = 0
										AND ERD.IS_APPROVE IS NULL
									</cfif>
									AND E.PROCESS_CAT IN (#attributes.process_type#)
								GROUP BY
									E.ACTION_TYPE,
									E.EXPENSE_ID,
									CTC.CONSUMER_ID
							)EXP1
						GROUP BY
							PARTNER_COMPANY_ID,
							PARTNER_CONSUMER_ID
					) BA_BS
					GROUP BY
						PARTNER_COMPANY_ID,
						PARTNER_CONSUMER_ID
				)  as aa
			<cfif isDefined("attributes.total") and len(attributes.total)>
				HAVING
					SUM(BS_TOTAL) > = #attributes.total# OR SUM(BA_TOTAL) > = #attributes.total#
			</cfif>
		</cfquery>
		<cfoutput query="get_related_member">
			<cfif len(partner_company_id)>
				<cfset 'ba_paper_count_#partner_company_id#' = BA_PAPER_COUNT>
				<cfset 'bs_paper_count_#partner_company_id#' = BS_PAPER_COUNT>
				<cfset 'ba_total_#partner_company_id#' = BA_TOTAL>
				<cfset 'bs_total_#partner_company_id#' = BS_TOTAL>
				<cfset 'tax_total_#partner_company_id#' = TAX_TOTAL>
				<cfset 'otv_total_#partner_company_id#' = OTV_TOTAL>
			</cfif>
			<cfif len(partner_consumer_id)>
				<cfset 'ba_paper_count_#partner_consumer_id#' = BA_PAPER_COUNT>
				<cfset 'bs_paper_count_#partner_consumer_id#' = BS_PAPER_COUNT>
				<cfset 'ba_total_#partner_consumer_id#' = BA_TOTAL>
				<cfset 'bs_total_#partner_consumer_id#' = BS_TOTAL>
				<cfset 'tax_total_#partner_consumer_id#' = TAX_TOTAL>
				<cfset 'otv_total_#partner_consumer_id#' = OTV_TOTAL>
			</cfif>
		</cfoutput>
	</cfif>
<cfset ba_belge_toplam = 0>
<cfset bs_belge_toplam = 0>
<cfset ba_net_toplam = 0>
<cfset bs_net_toplam = 0>
<cfset kdv_toplam = 0>
<cfset otv_toplam = 0>
<cfset adres = '&process_type_ba=#attributes.process_type_ba#&process_type_bs=#attributes.process_type_bs#'>
<cfif isDefined("attributes.startdate") and isdate(attributes.startdate)>
	<cfset adres = "#adres#&startdate=#dateformat(attributes.startdate,dateformat_style)#">
</cfif>
<cfif isDefined("attributes.finishdate") and isdate(attributes.finishdate)>
	<cfset adres = "#adres#&finishdate=#dateformat(attributes.finishdate,dateformat_style)#">
</cfif>
<cfif isDefined("attributes.company") and len(attributes.company)>
	<cfset adres = "#adres#&company=#attributes.company#">
</cfif>
<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
	<cfset adres = "#adres#&company_id=#attributes.company_id#">
</cfif>
<cfif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
	<cfset adres = "#adres#&consumer_id=#attributes.consumer_id#">
</cfif>
<cfif isDefined("attributes.row_company") and len(attributes.row_company)>
	<cfset adres = "#adres#&row_company=#attributes.row_company#">
</cfif>
<cfif isDefined("attributes.row_consumer") and len(attributes.row_consumer)>
	<cfset adres = "#adres#&row_consumer=#attributes.row_consumer#">
</cfif>
<cfif isDefined("attributes.process_type") and len(attributes.process_type)>
	<cfset adres = "#adres#&process_type=#attributes.process_type#">
</cfif>
<cfif isDefined("attributes.total") and len(attributes.total)>
	<cfset adres = "#adres#&total=#attributes.total#">
</cfif>
<!-- sil -->
<table style="width:200mm;" class="dph">
	<tr>
		<td align="right" style="text-align:right;"><cf_workcube_file_action pdf='1' mail='1' doc='1' print='1' trail='0'></td>
		<td style="width:1px;"><span class="wrkFileACtions no-print" style="margin-top:2px;"><a href="javascript://" onclick="windowopen('<cfoutput>#request.self#?fuseaction=report.popup_report_ba_bs_mail#adres#</cfoutput>','date');"><i class="fa fa-envelope-o" title="<cf_get_lang dictionary_id='33292.Toplu Mail Gönder'>" id="list_mail_button"></i></a></span></td>
	</tr>
</table>
<style type="text/css">
	.table,td {font-family: Verdana, Arial, Helvetica, sans-serif;}
	.font_text {font-size:11px;}
	.modal{display:none;}
	div[role="dialog"]
	{
		display:none;
	}
</style>
<cfoutput query="GET_BA_BS">
	<div class="ListContent">
		<table style="width:200mm;" border="0">
			<tr valign="top">
				<td style="width:5mm;"></td>
				<td><cfinclude template="../../objects/display/view_company_logo.cfm"></td>
			</tr>
			<tr valign="top">
				<td style="width:5mm;"></td>
				<td>
					<table border="0">
						<tr class="font_text">
							<td><p align="justify" style="line-height: 18px;">
								
								<cf_get_lang dictionary_id='49699.Sayın Yetkili'>
								</p>
							</td>
						</tr>						
						<tr class="font_text">
							<td><p align="justify" style="line-height: 18px;">
								
								<cf_get_lang dictionary_id='64439.381 Sıra Nolu Vergi Usul Kanunu Genel Tebliği gereğince, 213 sayılı Vergi Usul
								Kanununun (1) 148, 149 ve Mükerrer 257 nci maddelerinin verdiği yetkiye dayanılarak,
								362 Sıra Nolu Vergi Usul Kanunu Genel Tebliği (2) ile bilanço esasına göre defter tutan
								mükelleflerin belirli bir haddi aşan mal ve hizmet alımlarını "Mal ve Hizmet Alımlarına İlişkin
								Bildirim Formu (Form Ba)" ile;'> <cf_get_lang dictionary_id='64440.mal ve hizmet satışlarını ise "Mal ve Hizmet Satışlarına İlişkin
								Bildirim Formu (Form Bs)" ile vergilendirme dönemini takip eden ayın birinci gününden
								itibaren son günü akşamına kadar tebliğ etmesi gerektiği açıklanmıştır.'>
								</p>
							</td>
						</tr>						
						<tr class="font_text">
							<td><p align="justify" style="line-height: 18px;">
								
								<cf_get_lang dictionary_id='64441.2010 ve izleyen yılların aylık dönemlerine ilişkin mal ve/veya hizmet alışları ile
								 mal ve/veya hizmet satışlarına uygulanacak had 396 sıra no.lu Tebliğ ile'> #TLFormat(Limit_,0)#.
								</p>
							</td>
						</tr>						
						<tr class="font_text">
							<td><p align="justify" style="line-height: 18px;">
								
								#startdate#-#finishdate#  <cf_get_lang dictionary_id='65105.itibarı ile firmanız ile aramızda  düzenlenen fatura adedi ve tutarları aşağıdaki gibidir.'>
								</p>
							</td>
						</tr>						
						<tr class="font_text">
							<td><p align="justify" style="line-height: 18px;">
								
								<cf_get_lang dictionary_id='65104.Firma bilgileriniz ile birlikte fatura adet ve  tutarlarını kontrol edip, mutabık olmanız halinde kaşeleyip imzalayarak, mutabık olmadığınız takdirde firma bilgileriniz ile hesap ekstrenizi tarafımıza mail  veya faks yoluyla iletmenizi rica ederiz.'>
								</p>
							</td>
						</tr>						
						<tr class="font_text">
							<td><p align="justify" style="line-height: 18px;">
								
								<cf_get_lang dictionary_id='35935.Saygılarımızla'>
								</p>
							</td>
						</tr>						
						<cfquery name="get_info" datasource="#dsn#">
							<cfif (isdefined("attributes.company") and len(attributes.company) ) or  (isdefined("attributes.row_company") and len(attributes.row_company))>
								SELECT 
									COMPANY_ID,
									FULLNAME,
									MEMBER_CODE,
									TAXOFFICE,
									TAXNO,
									COMPANY_TELCODE TELCODE,
									COMPANY_TEL1 TEL,
									COMPANY_FAX FAX,
									COMPANY_EMAIL EMAIL,
									(SELECT CP.TC_IDENTITY FROM #dsn_alias#.COMPANY_PARTNER CP WHERE CP.PARTNER_ID = MANAGER_PARTNER_ID) TC_IDENTY_NO,
									CITY CITY_ID,
									COUNTRY COUNTRY_ID
								FROM 	
									COMPANY
								WHERE
									1 = 1
									<cfif isDefined("attributes.company_id") and len(attributes.company_id)>
										AND COMPANY_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#attributes.company_id#">
									</cfif>
									<cfif isDefined("attributes.row_company") and Len(attributes.row_company)>
										AND COMPANY_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#listfirst(attributes.row_company)#">
									</cfif>
							<cfelse>
								SELECT
									CONSUMER_ID,
									CONSUMER_NAME+' '+CONSUMER_SURNAME AS FULLNAME,
									MEMBER_CODE,
									TAX_OFFICE TAXOFFICE,
									TAX_NO TAXNO,
									MOBIL_CODE TELCODE,
									MOBILTEL TEL,
									CONSUMER_FAX FAX,
									IM EMAIL,
									TC_IDENTY_NO,
									HOME_CITY_ID CITY_ID,
									HOME_COUNTRY_ID COUNTRY_ID
								FROM 	
									CONSUMER
								WHERE
									1 = 1
									<cfif isDefined("attributes.consumer_id") and len(attributes.consumer_id)>
										AND CONSUMER_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#attributes.consumer_id#">
									</cfif>
									<cfif isDefined("attributes.row_consumer") and Len(attributes.row_consumer)>
										AND CONSUMER_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#listfirst(attributes.row_consumer)#">
									</cfif>
							</cfif>
						</cfquery>
						<tr>
							<td>
								<table border="0">
									<tr class="font_text">
										<td width="150"><cf_get_lang dictionary_id='34550.Firma Ünvanı'></td>
										<td>: #get_info.fullname#</td>
									</tr>
									<tr class="font_text">
										<td><cf_get_lang dictionary_id='58762.Vergi Dairesi'></td>
										<td>: #get_info.taxoffice#</td>
									</tr>
									<cfif len(get_info.tc_identy_no) and not len(get_info.taxno)>
										<tr class="font_text">
											<td><cf_get_lang dictionary_id='58025.TC Kimlik No'></td>
											<td>: #get_info.tc_identy_no#</td>
										</tr>
									<cfelseif len(get_info.taxno)>
										<tr class="font_text">
											<td><cf_get_lang dictionary_id='56085.Vergi Numarası'></td>
											<td>: #get_info.taxno#</td>
										</tr>
									</cfif>
									<tr class="font_text">
										<td><cf_get_lang dictionary_id='57499.Telefon'></td>
										<td>: <cfif Len(get_info.tel)>(#get_info.telcode#) #get_info.tel#<cfelse></cfif></td>
									</tr>
									<tr class="font_text">
										<td><cf_get_lang dictionary_id='48358.Faks'></td>
										<td>: <cfif Len(get_info.fax)>#get_info.fax#<cfelse></cfif></td>
									</tr>
										<tr class="font_text">
										<td><cf_get_lang dictionary_id='39210.Email'></td>
										<td>: <cfif Len(get_info.email)>#get_info.email#<cfelse></cfif></td>
									</tr>
								</table>
							</td>
						</tr>
						
						<tr><td class="formbold">#dateformat(attributes.startdate,dateformat_style)# - #dateformat(attributes.finishdate,dateformat_style)# Dönemi BA-BS Raporu</td></tr>
						<tr>
							<td>
								<table border="0" width="100%" align="center">
									<tr align="left" class="font_text">
										<td width="25%"><u><cf_get_lang dictionary_id='34017.BA Belge Adedi'></u></td>
										<td width="25%"><u>BA <cf_get_lang dictionary_id='54452.Tutar'></u></td>
										<td width="25%"><u><cf_get_lang dictionary_id='33977.BS Belge Adedi'></u></td>
										<td width="25%"><u>BS <cf_get_lang dictionary_id='54452.Tutar'></u></td>
									</tr>
									<tr align="left" class="font_text">
										<td>
											<cfset ba_paper_count_ = 0>
											<cfif isdefined("company_id") and  Len(company_id)>
												<cfif isdefined('ba_paper_count_#company_id#') and len(evaluate('ba_paper_count_#company_id#'))>
													<cfset ba_paper_count_ = #evaluate('ba_paper_count_#company_id#')#><!--- ilişkili üyenin bilgisi --->
													<cfset ba_belge_toplam = ba_belge_toplam + ba_paper_count + ba_paper_count_><!--- ilişkili üyenin hareketi tekrar toplama eklenmesin diye --->
												<cfelse>
													<cfset ba_paper_count_ = 0>
													<cfset ba_belge_toplam = ba_belge_toplam + ba_paper_count + ba_paper_count_>
												</cfif>
											<cfelseif isdefined("consumer_id") and Len(consumer_id)>
												<cfif isdefined('ba_paper_count_#consumer_id#') and len(evaluate('ba_paper_count_#consumer_id#'))>
													<cfset ba_paper_count_ = #evaluate('ba_paper_count_#consumer_id#')#>
													<cfset ba_belge_toplam = ba_belge_toplam + ba_paper_count + ba_paper_count_>
												<cfelse>
													<cfset ba_paper_count_ = 0>
													<cfset ba_belge_toplam = ba_belge_toplam + ba_paper_count + ba_paper_count_>
												</cfif>
											</cfif>
											#ba_paper_count + ba_paper_count_#
										</td>
										<td>
											<cfset ba_total_ = 0>
											<cfif isdefined("company_id") and Len(company_id)>
												<cfif isdefined('ba_total_#company_id#') and len(evaluate('ba_total_#company_id#'))>
													<cfset ba_total_ = #evaluate('ba_total_#company_id#')#><!--- ilişkili üyenin bilgisi --->
													<cfset ba_net_toplam = ba_net_toplam + ba_total + ba_total_>
												<cfelse>
													<cfset ba_total_ = 0>
													<cfset ba_net_toplam = ba_net_toplam + ba_total + ba_total_>
												</cfif>
											<cfelseif isdefined("consumer_id") and Len(consumer_id)>
												<cfif isdefined('ba_total_#consumer_id#') and len(evaluate('ba_total_#consumer_id#'))>
													<cfset ba_total_ = #evaluate('ba_total_#consumer_id#')#>
													<cfset ba_net_toplam = ba_net_toplam + ba_total+ ba_total_>
												<cfelse>
													<cfset ba_total_ = 0>
													<cfset ba_net_toplam = ba_net_toplam + ba_total + ba_total_>
												</cfif>
											</cfif>
											#TLFormat(ba_total + ba_total_)#
										</td>
										<td>
											<cfset bs_paper_count_ = 0>
											<cfif isdefined("company_id") and Len(company_id)>
												<cfif isdefined('bs_paper_count_#company_id#') and len(evaluate('bs_paper_count_#company_id#'))>
													<cfset bs_paper_count_ = #evaluate('bs_paper_count_#company_id#')#><!--- ilişkili üyenin bilgisi --->
													<cfset bs_belge_toplam = bs_belge_toplam + bs_paper_count + bs_paper_count_>
												<cfelse>
													<cfset bs_paper_count_ = 0>
													<cfset bs_belge_toplam = bs_belge_toplam + bs_paper_count + bs_paper_count_>
												</cfif>
											<cfelseif isdefined("consumer_id") and Len(consumer_id)>
												<cfif isdefined('bs_paper_count_#consumer_id#') and len(evaluate('bs_paper_count_#consumer_id#'))>
													<cfset bs_paper_count_ = #evaluate('bs_paper_count_#consumer_id#')#>
													<cfset bs_belge_toplam = bs_belge_toplam + bs_paper_count + bs_paper_count_>
												<cfelse>
													<cfset bs_paper_count_ = 0>
													<cfset bs_belge_toplam = bs_belge_toplam + bs_paper_count + bs_paper_count_>
												</cfif>
											</cfif>
											#bs_paper_count + bs_paper_count_#
										</td>
										<td>
											<cfset bs_total_ = 0>
											<cfif  isdefined("company_id") and Len(company_id)>
												<cfif isdefined('bs_total_#company_id#') and len(evaluate('bs_total_#company_id#'))>
													<cfset bs_total_ = #evaluate('bs_total_#company_id#')#><!--- ilişkili üyenin bilgisi --->
													<cfset bs_net_toplam = bs_net_toplam + bs_total + bs_total_>
												<cfelse>
													<cfset bs_total_ = 0>
													<cfset bs_net_toplam = bs_net_toplam + bs_total + bs_total_>
												</cfif>
											<cfelseif  isdefined("consumer_id") and Len(consumer_id)>
												<cfif isdefined('bs_total_#consumer_id#') and len(evaluate('bs_total_#consumer_id#'))>
													<cfset bs_total_ = #evaluate('bs_total_#consumer_id#')#>
													<cfset bs_net_toplam = bs_net_toplam + bs_total + bs_total_>
												<cfelse>
													<cfset bs_total_ = 0>
													<cfset bs_net_toplam = bs_net_toplam + bs_total + bs_total_>
												</cfif>
											</cfif>
											#TLFormat(bs_total + bs_total_)#
										</td>
									</tr>
									<tr><td height="50"></td></tr>
									<tr class="font_text">
										<td colspan="3"></td>
										<td><cf_get_lang dictionary_id='58957.İmza'></td>
									</tr>
								</table>
							</td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td></td>
				<cfif isdefined("x_mail_info") and x_mail_info eq 0><!--- kullanıcı bilgisi--->
					<td>
					<table bgcolor="FFFFFF" align="<cfoutput>#get_template_dimension.template_align#" style="width:#get_template_dimension.template_width##get_template_dimension.template_unit#</cfoutput>"> 
						<tr>
							<td width="20mm"></td>
							<td align="<cfoutput>#get_template_dimension.template_align#</cfoutput>">
							<hr noshade style="height:1px;">
								<cfquery name="Get_Employees" datasource="#dsn#">
									SELECT EMPLOYEE_ID,EMPLOYEE_NAME,EMPLOYEE_SURNAME,EMPLOYEE_EMAIL,EXTENSION FROM EMPLOYEES WHERE EMPLOYEE_ID = #session.ep.userid#
								</cfquery>
								<cfquery name="Our_Company" datasource="#dsn#">
									SELECT 
										COMPANY_NAME NAME_,
										TEL_CODE TELCODE_,
										TEL TEL1_,
										TEL2 TEL2_,
										TEL3 TEL3_,
										FAX FAX_,
										ADDRESS ADDRESS_,
										EMAIL EMAIL_,
										WEB WEB_
									FROM 
										OUR_COMPANY 
									WHERE 
										<cfif isdefined("attributes.our_company_id")>
											COMP_ID = <cfqueryparam cfsqltype="cf_sql_integer" value="#attributes.our_company_id#">
										<cfelse>
											<cfif isDefined("session.ep.company_id") and len(session.ep.company_id)>
												COMP_ID = #session.ep.company_id#
											<cfelseif isDefined("session.pp.company_id") and len(session.pp.company_id)>	
												COMP_ID = #session.pp.company_id#
											<cfelseif isDefined("session.ww.our_company_id")>
												COMP_ID = #session.ww.our_company_id#
											<cfelseif isDefined("session.cp.our_company_id")>
												COMP_ID = #session.cp.our_company_id#
											</cfif> 
										</cfif> 
								</cfquery>
								<table>
									<tr>
										<td colspan="2"><b>#Our_Company.NAME_#</b></td>
									</tr>
									<tr>
										<td colspan="2"><b>#session.ep.name# #session.ep.surname#</b></td>
									</tr>
									<tr>
										<td>
											<cfif len(Our_Company.tel1_) or len(Our_Company.tel2_) or  len(Our_Company.tel3_)><b><cf_get_lang dictionary_id='57499.Tel'>:</b> (#Our_Company.telcode_#) - #Our_Company.tel1_#  #Our_Company.tel2_#  #Our_Company.tel3_#</cfif>
											<cfif Len(Get_Employees.EXTENSION)><cf_get_lang dictionary_id='51669.Dahili'>:#Get_Employees.EXTENSION#</cfif>
										</td>
										<td><cfif len(Our_Company.fax_)><b><cf_get_lang dictionary_id='57488.Fax'>:</b> (#Our_Company.telcode_#) - #Our_Company.fax_#</cfif></td>
									</tr>
									<tr>
										<td colspan="2" style="width:350px;">#Our_Company.address_#</td>
									</tr>
									<tr>
										<td colspan="2">#Get_Employees.employee_email#</td>
									</tr>
									<tr>
										<td><a href="http://#Our_Company.web_#">#Our_Company.web_#</a></td>
									</tr>
								</table>
							</td>
						</tr>
					</table>
					</td>
				<cfelse><!--- sirket bilgisi --->
					<td><cfinclude template="../../objects/display/view_company_info.cfm"></td>
				</cfif>
			</tr>
			<tr>
				<td></td>
				<td></td>
			</tr>
		</table>
		<cfif GET_BA_BS.recordcount neq currentrow>
			<div style="page-break-before:always;"></div>
		</cfif>
	</div>
</cfoutput>
