<!-- Description : Nakit Akışı Viewine Proje eklendi
Developer: Fatih Kara
Company : Workcube
Destination: Period -->

<querytag>
	ALTER VIEW [@_dsn_period_@].[DAILY_DUE_REMAINDER] AS
		SELECT 
			SUM(BORC) BORC,
			SUM(BORC2) BORC2,
			SUM(ALACAK) ALACAK,
			SUM(ALACAK2) ALACAK2,
			SUM(BORC-ALACAK) BAKIYE,
			SUM(BORC2-ALACAK2) BAKIYE2,
			DUE_DATE,
            PROJECT_ID PROJECT_ID
		FROM
			(
			SELECT
				CR.ACTION_VALUE AS BORC,
				CR.ACTION_VALUE_2 AS BORC2,
				0 AS ALACAK,
				0 AS ALACAK2,
				CR.DUE_DATE,
				CR.CARI_ACTION_ID,
                CR.PROJECT_ID PROJECT_ID
			FROM
				CARI_ROWS CR
			WHERE 
				(TO_CMP_ID IS NOT NULL
				OR TO_CONSUMER_ID IS NOT NULL
				OR TO_EMPLOYEE_ID IS NOT NULL)
				AND CR.ACTION_ID NOT IN 
					(
						SELECT 
							ICR.ACTION_ID 
						FROM 
							CARI_CLOSED_ROW ICR,
							CARI_CLOSED IC
						WHERE 
							ICR.CLOSED_ID = IC.CLOSED_ID 
							AND ICR.CLOSED_AMOUNT IS NOT NULL
							AND CR.ACTION_TYPE_ID = ICR.ACTION_TYPE_ID
							AND ((CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS' AND CR.CARI_ACTION_ID = ICR.CARI_ACTION_ID) OR (CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS'))
							AND (((CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS') AND CR.DUE_DATE = ICR.DUE_DATE) OR (CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS'))
							AND CR.OTHER_MONEY = ICR.OTHER_MONEY	
					)
				AND CR.ACTION_TYPE_ID IN (40,50,52,53,56,57,58,62,66,531,561,48,121)
		UNION ALL
			SELECT
				(CR.ACTION_VALUE-ROUND(SUM(ICR.CLOSED_AMOUNT),2)) AS BORC,
				(CR.ACTION_VALUE-ROUND(SUM(ICR.CLOSED_AMOUNT),2))/(CR.ACTION_VALUE/CR.ACTION_VALUE_2) AS BORC2,
				0 AS ALACAK,
				0 AS ALACAK2,
				CR.DUE_DATE,
				CR.CARI_ACTION_ID,
                CR.PROJECT_ID PROJECT_ID
			FROM
				CARI_ROWS CR,
				CARI_CLOSED_ROW ICR
			WHERE 
				CR.ACTION_ID = ICR.ACTION_ID
				AND CR.ACTION_TYPE_ID = ICR.ACTION_TYPE_ID
				AND ((CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS' AND CR.CARI_ACTION_ID = ICR.CARI_ACTION_ID) OR (CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS'))
				AND (((CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS') AND CR.DUE_DATE = ICR.DUE_DATE) OR (CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS'))
				AND (TO_CMP_ID IS NOT NULL
				OR TO_CONSUMER_ID IS NOT NULL
				OR TO_EMPLOYEE_ID IS NOT NULL)	
				AND CR.ACTION_TYPE_ID IN (40,50,52,53,56,57,58,62,66,531,561,48,121)
			GROUP BY
				CR.ACTION_VALUE,
				CR.ACTION_VALUE_2,
				CR.DUE_DATE,
				CR.CARI_ACTION_ID,
                CR.PROJECT_ID	
		UNION ALL
			SELECT
				0 AS BORC,
				0 AS BORC2,
				CR.ACTION_VALUE AS ALACAK,
				CR.ACTION_VALUE_2 AS ALACAK2,
				CR.DUE_DATE,
				CR.CARI_ACTION_ID,
                CR.PROJECT_ID PROJECT_ID
			FROM
				CARI_ROWS CR
			WHERE
				(FROM_CMP_ID IS NOT NULL
				OR FROM_CONSUMER_ID IS NOT NULL
				OR FROM_EMPLOYEE_ID IS NOT NULL	)
				AND CR.ACTION_ID NOT IN 
					(
						SELECT 
							ICR.ACTION_ID 
						FROM 
							CARI_CLOSED_ROW ICR,
							CARI_CLOSED IC
						WHERE 
							ICR.CLOSED_ID = IC.CLOSED_ID 
							AND ICR.CLOSED_AMOUNT IS NOT NULL
							AND CR.ACTION_TYPE_ID = ICR.ACTION_TYPE_ID
							AND ((CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS' AND CR.CARI_ACTION_ID = ICR.CARI_ACTION_ID) OR (CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS'))
							AND (((CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS') AND CR.DUE_DATE = ICR.DUE_DATE) OR (CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS'))
							AND CR.OTHER_MONEY = ICR.OTHER_MONEY	
					)
				AND CR.ACTION_TYPE_ID IN (40,51,54,55,59,591,592,60,61,63,64,65,68,690,691,601,49,120,122)
		UNION ALL
			SELECT
				0 AS BORC,
				0 AS BORC2,
				(CR.ACTION_VALUE-ROUND(SUM(ICR.CLOSED_AMOUNT),2))AS ALACAK,
				(CR.ACTION_VALUE-ROUND(SUM(ICR.CLOSED_AMOUNT),2))/(CR.ACTION_VALUE/CR.ACTION_VALUE_2) AS ALACAK2,
				CR.DUE_DATE,
				CR.CARI_ACTION_ID,
                CR.PROJECT_ID PROJECT_ID
			FROM
				CARI_ROWS CR,
				CARI_CLOSED_ROW ICR
			WHERE
				CR.ACTION_ID = ICR.ACTION_ID
				AND CR.ACTION_TYPE_ID = ICR.ACTION_TYPE_ID
				AND ((CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS' AND CR.CARI_ACTION_ID = ICR.CARI_ACTION_ID) OR (CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS'))
				AND (((CR.ACTION_TABLE = 'INVOICE' OR CR.ACTION_TABLE = 'EXPENSE_ITEM_PLANS') AND CR.DUE_DATE = ICR.DUE_DATE) OR (CR.ACTION_TABLE <> 'INVOICE' AND CR.ACTION_TABLE <> 'EXPENSE_ITEM_PLANS'))
				AND (FROM_CMP_ID IS NOT NULL
				OR FROM_CONSUMER_ID IS NOT NULL
				OR FROM_EMPLOYEE_ID IS NOT NULL)
				AND CR.ACTION_TYPE_ID IN (40,51,54,55,59,591,592,60,61,63,64,65,68,690,691,601,49,120,122)	
			GROUP BY
				CR.ACTION_VALUE,
				CR.ACTION_VALUE_2,
				CR.DUE_DATE	,
				CR.CARI_ACTION_ID,
                CR.PROJECT_ID	
		) AS CARI_TOPLAM_1
		GROUP BY DUE_DATE,
        PROJECT_ID

</querytag>